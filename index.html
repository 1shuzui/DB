<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工厂氟胶垫片库存交易管理系统</title>
    <!-- 引入样式库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入Bootstrap Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .sidebar {
            background-color: var(--primary-color);
            color: white;
            min-height: 100vh;
            padding: 0;
            position: fixed;
            width: 250px;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 15px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--secondary-color);
            color: white;
            transform: translateX(5px);
        }

        .sidebar .nav-link i {
            width: 25px;
            text-align: center;
            margin-right: 10px;
            font-size: 18px;
        }

        .content-area {
            margin-left: 250px;
            padding: 0;
            transition: margin-left 0.3s;
        }

        .content-header {
            background-color: white;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 99;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card {
            border: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #eef1f5;
            padding: 18px 25px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h5, .card-header h6 {
            margin: 0;
            color: var(--primary-color);
        }

        .stat-card {
            border-radius: 12px;
            padding: 25px;
            color: white;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255,255,255,0.1);
            transform: rotate(45deg);
        }

        .stat-card.blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stat-card.green { background: linear-gradient(135deg, #27ae60, #229954); }
        .stat-card.orange { background: linear-gradient(135deg, #f39c12, #d68910); }
        .stat-card.red { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-card.purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .stat-card.teal { background: linear-gradient(135deg, #1abc9c, #16a085); }

        .stat-card .card-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-card .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .stat-card .card-desc {
            font-size: 13px;
            opacity: 0.8;
        }

        .alert-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }

        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
            margin: 10px 0;
        }

        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .status-active { background-color: #d5f4e6; color: #27ae60; }
        .status-inactive { background-color: #fadbd8; color: #e74c3c; }
        .status-pending { background-color: #fef9e7; color: #f39c12; }
        .status-completed { background-color: #d6eaf8; color: #3498db; }
        .status-cancelled { background-color: #e8e8e8; color: #7f8c8d; }

        .material-badge {
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .material-fluor { background-color: #d6eaf8; color: #3498db; border: 1px solid #aed6f1; }
        .material-gasket { background-color: #fdebd0; color: #e67e22; border: 1px solid #fad7a0; }
        .material-other { background-color: #e8daef; color: #8e44ad; border: 1px solid #d2b4de; }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .priority-high { background-color: #fadbd8; color: #e74c3c; }
        .priority-medium { background-color: #fef9e7; color: #f39c12; }
        .priority-low { background-color: #d5f4e6; color: #27ae60; }

        .table-hover tbody tr {
            transition: all 0.2s;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.07);
            transform: translateX(3px);
        }

        /* 连接状态指示器 */
        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .connection-connected { background-color: #d5f4e6; color: #27ae60; border: 1px solid #27ae60; }
        .connection-disconnected { background-color: #fadbd8; color: #e74c3c; border: 1px solid #e74c3c; }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 操作按钮组 */
        .btn-action-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-action-group .btn {
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        /* 标签页切换 */
        .tab-content {
            padding: 20px;
        }

        /* 搜索框样式 */
        .search-box {
            position: relative;
        }

        .search-box .form-control {
            padding-left: 40px;
            border-radius: 25px;
            border: 1px solid #e0e0e0;
        }

        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
        }

        /* 表单样式 */
        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }

        /* 进度条样式 */
        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: #ecf0f1;
        }

        .progress-bar {
            border-radius: 5px;
        }

        /* 模态框样式 */
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-bottom: none;
            border-radius: 0;
        }

        .modal-title {
            font-weight: 600;
        }

        .modal-footer {
            border-top: 1px solid #eef1f5;
            padding: 20px;
        }

        /* 分页样式 */
        .pagination {
            margin-bottom: 0;
        }

        .page-link {
            border: none;
            color: var(--primary-color);
            margin: 0 3px;
            border-radius: 6px;
            padding: 8px 15px;
        }

        .page-item.active .page-link {
            background-color: var(--secondary-color);
            color: white;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar .nav-link span {
                display: none;
            }

            .sidebar .nav-link i {
                margin-right: 0;
                font-size: 20px;
            }

            .content-area {
                margin-left: 70px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .card-header .btn-group {
                align-self: flex-end;
            }
        }

        /* 动画效果 */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 标签页内容 */
        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        /* 徽章样式 */
        .badge {
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* 下拉菜单 */
        .dropdown-menu {
            border: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            padding: 10px 0;
        }

        .dropdown-item {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        /* 工具提示 */
        .tooltip-inner {
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="text-white mt-3">加载中，请稍候...</div>
    </div>

    <!-- 连接状态指示器 -->
    <div class="connection-status connection-disconnected" id="connection-status">
        <i class="fas fa-plug"></i> <span id="connection-text">连接中...</span>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="position-sticky pt-3">
            <div class="text-center py-4">
                <h4 class="mb-0">
                    <i class="fas fa-industry me-2"></i>
                    <span class="sidebar-title">工厂管理系统</span>
                </h4>
                <small class="text-muted">v2.0</small>
            </div>

            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-target="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>仪表盘</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="products">
                        <i class="fas fa-boxes"></i>
                        <span>产品管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="inventory">
                        <i class="fas fa-warehouse"></i>
                        <span>库存管理</span>
                        <span class="alert-badge" id="alert-count">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="purchase">
                        <i class="fas fa-shopping-cart"></i>
                        <span>采购管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="sales">
                        <i class="fas fa-chart-line"></i>
                        <span>销售管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="customers">
                        <i class="fas fa-users"></i>
                        <span>客户管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="suppliers">
                        <i class="fas fa-truck"></i>
                        <span>供应商管理</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="reports">
                        <i class="fas fa-chart-pie"></i>
                        <span>统计报表</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="system">
                        <i class="fas fa-cog"></i>
                        <span>系统设置</span>
                    </a>
                </li>
            </ul>

            <div class="px-3 mt-5">
                <div class="card bg-dark text-white">
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle me-2"></i>系统信息</h6>
                        <small>
                            <div class="d-flex justify-content-between">
                                <span>产品总数:</span>
                                <span id="total-products">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>库存总额:</span>
                                <span>¥<span id="total-inventory">0</span></span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>今日订单:</span>
                                <span id="today-orders">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>API状态:</span>
                                <span id="api-status">❌ 未连接</span>
                            </div>
                        </small>
                    </div>
                </div>
            </div>

            <div class="px-3 mt-3">
                <button class="btn btn-sm btn-outline-light w-100" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-2"></i>刷新系统
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="content-area">
        <!-- 顶部导航 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom content-header">
            <div class="container-fluid">
                <button class="navbar-toggler d-md-none" type="button" id="sidebarToggle">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="d-flex align-items-center">
                    <h5 class="mb-0" id="page-title">仪表盘</h5>
                    <small class="text-muted ms-3" id="page-subtitle">实时监控系统运行状态</small>
                </div>

                <div class="d-flex align-items-center">
                    <div class="dropdown me-3">
                        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus me-1"></i>新建
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showNewProductModal()"><i class="fas fa-box me-2"></i>新产品</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showNewOrderModal('purchase')"><i class="fas fa-shopping-cart me-2"></i>采购订单</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showNewOrderModal('sales')"><i class="fas fa-file-invoice-dollar me-2"></i>销售订单</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showNewCustomerModal()"><i class="fas fa-user-plus me-2"></i>新客户</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showNewSupplierModal()"><i class="fas fa-truck me-2"></i>新供应商</a></li>
                        </ul>
                    </div>

                    <div class="dropdown me-3">
                        <button class="btn btn-outline-info btn-sm" type="button" onclick="testConnection()">
                            <i class="fas fa-plug me-1"></i>测试连接
                        </button>
                    </div>

                    <div class="dropdown">
                        <button class="btn btn-light rounded-circle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">管理员</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="showSystemInfo()"><i class="fas fa-info-circle me-2"></i>系统信息</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showDatabaseStatus()"><i class="fas fa-database me-2"></i>数据库状态</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="location.reload()"><i class="fas fa-sync-alt me-2"></i>刷新页面</a></li>
                            <li><a class="dropdown-item" href="#" onclick="clearCache()"><i class="fas fa-trash me-2"></i>清除缓存</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 标签页内容 -->
        <div class="tab-content">
            <!-- 仪表盘 -->
            <div class="tab-pane active fade-in" id="dashboard">
                <!-- 统计卡片 -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card blue">
                            <div class="card-body">
                                <h5 class="card-title">总库存价值</h5>
                                <h2 class="card-value">¥ <span id="stat-total-value">0</span></h2>
                                <div class="card-desc">共 <span id="stat-total-items">0</span> 个产品</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card green">
                            <div class="card-body">
                                <h5 class="card-title">本月销售额</h5>
                                <h2 class="card-value">¥ <span id="stat-month-sales">0</span></h2>
                                <div class="card-desc">较上月 <span id="stat-sales-growth">0%</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card orange">
                            <div class="card-body">
                                <h5 class="card-title">库存预警</h5>
                                <h2 class="card-value"><span id="stat-alerts">0</span> 个</h2>
                                <div class="card-desc"><span id="stat-low-stock">0</span> 个库存不足</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card red">
                            <div class="card-body">
                                <h5 class="card-title">待处理订单</h5>
                                <h2 class="card-value"><span id="stat-pending-orders">0</span> 个</h2>
                                <div class="card-desc"><span id="stat-pending-purchase">0</span> 采购 / <span id="stat-pending-sales">0</span> 销售</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表区 -->
                <div class="row mb-4">
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>月度销售趋势</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        时间范围
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="setChartRange(3)">最近3个月</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setChartRange(6)">最近6个月</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setChartRange(12)">最近12个月</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-pie me-2 text-primary"></i>产品类别分布</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 库存预警列表 -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-exclamation-triangle text-warning me-2"></i>库存预警</h6>
                                <small class="text-muted">实时监控</small>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="alerts-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>产品编码</th>
                                                <th>产品名称</th>
                                                <th>当前库存</th>
                                                <th>预警类型</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 动态加载 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="p-3 text-center">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadInventoryAlerts()">
                                        <i class="fas fa-sync-alt me-1"></i>刷新预警
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-history me-2 text-primary"></i>近期库存变动</h6>
                                <small class="text-muted">最近10条记录</small>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="transactions-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>时间</th>
                                                <th>产品</th>
                                                <th>类型</th>
                                                <th>变动量</th>
                                                <th>结存</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 动态加载 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="p-3 text-center">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadInventoryTransactions()">
                                        <i class="fas fa-eye me-1"></i>查看全部
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 产品管理 -->
            <div class="tab-pane fade-in" id="products">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2 text-primary"></i>产品列表</h5>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="showNewProductModal()">
                                <i class="fas fa-plus me-1"></i>添加产品
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="exportProducts()">
                                <i class="fas fa-download me-1"></i>导出
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="importProducts()">
                                <i class="fas fa-upload me-1"></i>导入
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选工具栏 -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-material" onchange="loadProducts(1)">
                                    <option value="">全部材料类型</option>
                                    <option value="氟胶">氟胶</option>
                                    <option value="垫片">垫片</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-category" onchange="loadProducts(1)">
                                    <option value="">全部类别</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-status" onchange="loadProducts(1)">
                                    <option value="">全部状态</option>
                                    <option value="正常">正常</option>
                                    <option value="停用">停用</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="input-group input-group-sm search-box">
                                    <span class="input-group-text search-icon"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="搜索产品名称或编码" id="search-product">
                                    <button class="btn btn-outline-primary" type="button" onclick="loadProducts(1)">
                                        搜索
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 产品表格 -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="products-table">
                                <thead>
                                    <tr>
                                        <th>产品编码</th>
                                        <th>产品名称</th>
                                        <th>类别</th>
                                        <th>材料类型</th>
                                        <th>规格</th>
                                        <th>单价</th>
                                        <th>库存</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        <nav aria-label="产品分页">
                            <ul class="pagination justify-content-center" id="products-pagination">
                                <!-- 动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 库存管理 -->
            <div class="tab-pane fade-in" id="inventory">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-warehouse me-2 text-primary"></i>库存明细</h5>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="showStockAdjustModal()">
                                <i class="fas fa-edit me-1"></i>批量调整
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="loadInventory()">
                                <i class="fas fa-sync-alt me-1"></i>刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 库存统计 -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">氟胶制品库存</h6>
                                        <small class="text-muted">总价值: ¥<span id="fluor-total-value">0</span></small>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="flex-grow-1 me-3">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" id="fluor-progress" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted" id="fluor-percent">0%</small>
                                            </div>
                                        </div>
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <small class="text-muted">总库存</small>
                                                <h5 id="fluor-total">0</h5>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">安全库存</small>
                                                <h5 id="fluor-safe">0</h5>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">预警数量</small>
                                                <h5 class="text-danger" id="fluor-alert">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">垫片制品库存</h6>
                                        <small class="text-muted">总价值: ¥<span id="gasket-total-value">0</span></small>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="flex-grow-1 me-3">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" role="progressbar" id="gasket-progress" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted" id="gasket-percent">0%</small>
                                            </div>
                                        </div>
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <small class="text-muted">总库存</small>
                                                <h5 id="gasket-total">0</h5>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">安全库存</small>
                                                <h5 id="gasket-safe">0</h5>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">预警数量</small>
                                                <h5 class="text-danger" id="gasket-alert">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 库存明细表格 -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="inventory-table">
                                <thead>
                                    <tr>
                                        <th>产品编码</th>
                                        <th>产品名称</th>
                                        <th>材料类型</th>
                                        <th>当前库存</th>
                                        <th>最低库存</th>
                                        <th>最高库存</th>
                                        <th>库存状态</th>
                                        <th>仓库位置</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 采购管理 -->
            <div class="tab-pane fade-in" id="purchase">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-shopping-cart me-2 text-primary"></i>采购管理</h5>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="showNewPurchaseOrderModal()">
                                <i class="fas fa-plus me-1"></i>新建采购订单
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="loadPurchaseOrders(1)">
                                <i class="fas fa-sync-alt me-1"></i>刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选工具栏 -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-purchase-status" onchange="loadPurchaseOrders(1)">
                                    <option value="">全部状态</option>
                                    <option value="待审核">待审核</option>
                                    <option value="已批准">已批准</option>
                                    <option value="已发货">已发货</option>
                                    <option value="已完成">已完成</option>
                                    <option value="已取消">已取消</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-purchase-supplier" onchange="loadPurchaseOrders(1)">
                                    <option value="">全部供应商</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <input type="date" class="form-control form-control-sm" id="filter-purchase-date" placeholder="选择日期" onchange="loadPurchaseOrders(1)">
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="input-group input-group-sm search-box">
                                    <span class="input-group-text search-icon"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="搜索订单号" id="search-purchase">
                                    <button class="btn btn-outline-primary" type="button" onclick="loadPurchaseOrders(1)">
                                        搜索
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 采购订单表格 -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="purchase-orders-table">
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>供应商</th>
                                        <th>订单日期</th>
                                        <th>预计交货</th>
                                        <th>订单总额</th>
                                        <th>状态</th>
                                        <th>创建人</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        <nav aria-label="采购订单分页">
                            <ul class="pagination justify-content-center" id="purchase-pagination">
                                <!-- 动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 销售管理 -->
            <div class="tab-pane fade-in" id="sales">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>销售管理</h5>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="showNewSalesOrderModal()">
                                <i class="fas fa-plus me-1"></i>新建销售订单
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="loadSalesOrders(1)">
                                <i class="fas fa-sync-alt me-1"></i>刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选工具栏 -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-sales-status" onchange="loadSalesOrders(1)">
                                    <option value="">全部状态</option>
                                    <option value="待处理">待处理</option>
                                    <option value="已确认">已确认</option>
                                    <option value="发货中">发货中</option>
                                    <option value="已完成">已完成</option>
                                    <option value="已取消">已取消</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-sales-customer" onchange="loadSalesOrders(1)">
                                    <option value="">全部客户</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-sales-payment" onchange="loadSalesOrders(1)">
                                    <option value="">支付状态</option>
                                    <option value="未支付">未支付</option>
                                    <option value="部分支付">部分支付</option>
                                    <option value="已支付">已支付</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="input-group input-group-sm search-box">
                                    <span class="input-group-text search-icon"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="搜索订单号" id="search-sales">
                                    <button class="btn btn-outline-primary" type="button" onclick="loadSalesOrders(1)">
                                        搜索
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 销售订单表格 -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="sales-orders-table">
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>客户</th>
                                        <th>订单日期</th>
                                        <th>交货日期</th>
                                        <th>订单总额</th>
                                        <th>状态</th>
                                        <th>支付状态</th>
                                        <th>创建人</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        <nav aria-label="销售订单分页">
                            <ul class="pagination justify-content-center" id="sales-pagination">
                                <!-- 动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 客户管理 -->
            <div class="tab-pane fade-in" id="customers">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users me-2 text-primary"></i>客户管理</h5>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="showNewCustomerModal()">
                                <i class="fas fa-plus me-1"></i>添加客户
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="exportCustomers()">
                                <i class="fas fa-download me-1"></i>导出
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选工具栏 -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-customer-type" onchange="loadCustomers(1)">
                                    <option value="">全部类型</option>
                                    <option value="代理商">代理商</option>
                                    <option value="终端客户">终端客户</option>
                                    <option value="经销商">经销商</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-customer-status" onchange="loadCustomers(1)">
                                    <option value="">全部状态</option>
                                    <option value="活跃">活跃</option>
                                    <option value="休眠">休眠</option>
                                    <option value="终止">终止</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-customer-credit" onchange="loadCustomers(1)">
                                    <option value="">全部信用等级</option>
                                    <option value="高">高</option>
                                    <option value="中">中</option>
                                    <option value="低">低</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="input-group input-group-sm search-box">
                                    <span class="input-group-text search-icon"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="搜索客户名称或编码" id="search-customer">
                                    <button class="btn btn-outline-primary" type="button" onclick="loadCustomers(1)">
                                        搜索
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 客户表格 -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="customers-table">
                                <thead>
                                    <tr>
                                        <th>客户编码</th>
                                        <th>客户名称</th>
                                        <th>联系人</th>
                                        <th>联系电话</th>
                                        <th>客户类型</th>
                                        <th>信用等级</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        <nav aria-label="客户分页">
                            <ul class="pagination justify-content-center" id="customers-pagination">
                                <!-- 动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 供应商管理 -->
            <div class="tab-pane fade-in" id="suppliers">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-truck me-2 text-primary"></i>供应商管理</h5>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="showNewSupplierModal()">
                                <i class="fas fa-plus me-1"></i>添加供应商
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="exportSuppliers()">
                                <i class="fas fa-download me-1"></i>导出
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选工具栏 -->
                        <div class="row mb-3">
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-supplier-rating" onchange="loadSuppliers(1)">
                                    <option value="">全部评级</option>
                                    <option value="A">A级</option>
                                    <option value="B">B级</option>
                                    <option value="C">C级</option>
                                    <option value="D">D级</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm" id="filter-supplier-status" onchange="loadSuppliers(1)">
                                    <option value="">全部状态</option>
                                    <option value="合作中">合作中</option>
                                    <option value="已终止">已终止</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="input-group input-group-sm search-box">
                                    <span class="input-group-text search-icon"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="搜索供应商名称或编码" id="search-supplier">
                                    <button class="btn btn-outline-primary" type="button" onclick="loadSuppliers(1)">
                                        搜索
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 供应商表格 -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="suppliers-table">
                                <thead>
                                    <tr>
                                        <th>供应商编码</th>
                                        <th>供应商名称</th>
                                        <th>联系人</th>
                                        <th>联系电话</th>
                                        <th>评级</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        <nav aria-label="供应商分页">
                            <ul class="pagination justify-content-center" id="suppliers-pagination">
                                <!-- 动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 统计报表 -->
            <div class="tab-pane fade-in" id="reports">
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i>销售统计报表</h5>
                            </div>
                            <div class="card-body">
                                <!-- 报表筛选 -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <label class="form-label">开始日期</label>
                                        <input type="date" class="form-control" id="report-start-date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">结束日期</label>
                                        <input type="date" class="form-control" id="report-end-date">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">统计维度</label>
                                        <select class="form-select" id="report-dimension">
                                            <option value="daily">按日</option>
                                            <option value="weekly">按周</option>
                                            <option value="monthly">按月</option>
                                            <option value="quarterly">按季</option>
                                            <option value="yearly">按年</option>
                                            <option value="category">按产品类别</option>
                                            <option value="customer">按客户</option>
                                            <option value="supplier">按供应商</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" onclick="generateReport()">
                                            <i class="fas fa-chart-bar me-1"></i>生成报表
                                        </button>
                                    </div>
                                </div>

                                <!-- 报表图表 -->
                                <div class="chart-container">
                                    <canvas id="reportChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-pie me-2 text-primary"></i>采购统计</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="purchaseChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>库存周转分析</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="inventoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统设置 -->
            <div class="tab-pane fade-in" id="system">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cog me-2 text-primary"></i>系统设置</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3"><i class="fas fa-plug me-2"></i>API连接配置</h6>
                                <div class="mb-3">
                                    <label class="form-label">API地址</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="api-url" value="http://127.0.0.1:5000/api">
                                        <button class="btn btn-outline-secondary" type="button" onclick="updateApiUrl()">
                                            更新
                                        </button>
                                    </div>
                                    <small class="text-muted">当前API地址: <span id="current-api-url">http://127.0.0.1:5000/api</span></small>
                                </div>

                                <button class="btn btn-info mb-3" onclick="testConnection()">
                                    <i class="fas fa-plug me-1"></i>测试API连接
                                </button>

                                <h6 class="mt-4"><i class="fas fa-database me-2"></i>数据库状态</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div id="database-status">正在检查数据库状态...</div>
                                    </div>
                                </div>

                                <h6 class="mt-4"><i class="fas fa-bell me-2"></i>库存预警设置</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable-alerts" checked>
                                            <label class="form-check-label" for="enable-alerts">启用库存预警</label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable-email-alerts">
                                            <label class="form-check-label" for="enable-email-alerts">启用邮件通知</label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable-auto-reorder">
                                            <label class="form-check-label" for="enable-auto-reorder">启用自动补货</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>系统信息</h6>
                                <ul class="list-group mb-4">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>前端版本</span>
                                        <span class="badge bg-primary">2.0.0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>后端API版本</span>
                                        <span class="badge bg-primary" id="api-version">未知</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>数据库版本</span>
                                        <span class="badge bg-primary" id="db-version">未知</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>最后数据同步</span>
                                        <span id="last-sync">从未同步</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>用户在线数</span>
                                        <span class="badge bg-success">1</span>
                                    </li>
                                </ul>

                                <h6 class="mt-4"><i class="fas fa-tools me-2"></i>系统操作</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="location.reload()">
                                        <i class="fas fa-sync-alt me-1"></i>刷新页面
                                    </button>
                                    <button class="btn btn-outline-success" onclick="loadAllData()">
                                        <i class="fas fa-database me-1"></i>重新加载数据
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="clearCache()">
                                        <i class="fas fa-trash-alt me-1"></i>清除缓存
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="backupDatabase()">
                                        <i class="fas fa-save me-1"></i>备份数据库
                                    </button>
                                </div>

                                <h6 class="mt-4"><i class="fas fa-shield-alt me-2"></i>安全设置</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">自动登出时间(分钟)</label>
                                            <input type="number" class="form-control" id="logout-time" value="30" min="5" max="480">
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable-ssl" checked>
                                            <label class="form-check-label" for="enable-ssl">启用SSL加密</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enable-logging" checked>
                                            <label class="form-check-label" for="enable-logging">启用操作日志</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->

    <!-- 新建产品模态框 -->
    <div class="modal fade" id="newProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新产品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="new-product-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">产品编码 *</label>
                                <input type="text" class="form-control" name="product_code" required id="new-product-code" placeholder="例如: P001">
                                <small class="text-muted">系统会自动生成产品编码，您也可以自定义</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">产品名称 *</label>
                                <input type="text" class="form-control" name="product_name" required placeholder="例如: 氟胶O型圈-10mm">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">材料类型 *</label>
                                <select class="form-select" name="material_type" required>
                                    <option value="">请选择材料类型</option>
                                    <option value="氟胶">氟胶</option>
                                    <option value="垫片">垫片</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">产品类别</label>
                                <select class="form-select" name="category_id" id="product-category-select">
                                    <option value="">选择类别</option>
                                    <option value="1">密封件</option>
                                    <option value="2">垫片</option>
                                    <option value="3">O型圈</option>
                                    <option value="4">其他配件</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">规格描述</label>
                                <textarea class="form-control" name="specification" rows="2" placeholder="例如: 内径10mm,截面2mm,耐高温250°C,耐油性良好"></textarea>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">单价 (元) *</label>
                                <input type="number" class="form-control" name="unit_price" step="0.01" min="0" required placeholder="0.00">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">计量单位</label>
                                <input type="text" class="form-control" name="unit" value="个" placeholder="个、片、米等">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">初始库存</label>
                                <input type="number" class="form-control" name="current_stock" min="0" value="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">最低库存预警</label>
                                <input type="number" class="form-control" name="min_stock_level" min="0" value="10">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">最高库存预警</label>
                                <input type="number" class="form-control" name="max_stock_level" min="0" value="1000">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">安全库存</label>
                                <input type="number" class="form-control" name="safety_stock" min="0" value="50">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">仓库位置</label>
                                <input type="text" class="form-control" name="warehouse_location" placeholder="例如: A区-01架-03层">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" name="notes" rows="2" placeholder="其他需要说明的信息"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitNewProduct()">
                        <i class="fas fa-save me-1"></i>保存产品
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑产品模态框 (动态生成) -->

    <!-- 新建采购订单模态框 -->
    <div class="modal fade" id="newPurchaseOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建采购订单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="mb-3">订单基本信息</h6>
                            <div class="mb-3">
                                <label class="form-label">供应商 *</label>
                                <select class="form-select" id="purchase-supplier-select" required>
                                    <option value="">选择供应商</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">订单日期 *</label>
                                <input type="date" class="form-control" id="purchase-order-date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">预计交货日期 *</label>
                                <input type="date" class="form-control" id="purchase-delivery-date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">订单备注</label>
                                <textarea class="form-control" id="purchase-notes" rows="3" placeholder="订单特殊要求或其他说明"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">优先级</label>
                                <select class="form-select" id="purchase-priority">
                                    <option value="低">低</option>
                                    <option value="中" selected>中</option>
                                    <option value="高">高</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="mb-3">订单明细</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm" id="purchase-items-table">
                                    <thead>
                                        <tr>
                                            <th>产品</th>
                                            <th>数量</th>
                                            <th>单价</th>
                                            <th>金额</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id="no-purchase-items">
                                            <td colspan="5" class="text-center text-muted py-4">
                                                暂无产品，请点击"添加产品"按钮添加
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-sm btn-primary" onclick="addPurchaseItem()">
                                    <i class="fas fa-plus me-1"></i>添加产品
                                </button>
                                <div>
                                    <h5 class="mb-0">订单总额: ¥<span id="purchase-total-amount">0.00</span></h5>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>提示：采购订单提交后需要审核，审核通过后才会更新库存</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitPurchaseOrder()">
                        <i class="fas fa-paper-plane me-1"></i>提交采购订单
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建销售订单模态框 -->
    <div class="modal fade" id="newSalesOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建销售订单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="mb-3">订单基本信息</h6>
                            <div class="mb-3">
                                <label class="form-label">客户 *</label>
                                <select class="form-select" id="sales-customer-select" required>
                                    <option value="">选择客户</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">订单日期 *</label>
                                <input type="date" class="form-control" id="sales-order-date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">交货日期</label>
                                <input type="date" class="form-control" id="sales-delivery-date">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">支付方式</label>
                                <select class="form-select" id="sales-payment-method">
                                    <option value="现金">现金</option>
                                    <option value="银行转账" selected>银行转账</option>
                                    <option value="支付宝">支付宝</option>
                                    <option value="微信支付">微信支付</option>
                                    <option value="赊销">赊销</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">订单备注</label>
                                <textarea class="form-control" id="sales-notes" rows="3" placeholder="订单特殊要求或其他说明"></textarea>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="mb-3">订单明细</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm" id="sales-items-table">
                                    <thead>
                                        <tr>
                                            <th>产品</th>
                                            <th>数量</th>
                                            <th>单价</th>
                                            <th>金额</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id="no-sales-items">
                                            <td colspan="5" class="text-center text-muted py-4">
                                                暂无产品，请点击"添加产品"按钮添加
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-sm btn-primary" onclick="addSalesItem()">
                                    <i class="fas fa-plus me-1"></i>添加产品
                                </button>
                                <div>
                                    <h5 class="mb-0">订单总额: ¥<span id="sales-total-amount">0.00</span></h5>
                                </div>
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <small>注意：销售订单会立即扣减库存，请确保库存充足</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitSalesOrder()">
                        <i class="fas fa-paper-plane me-1"></i>提交销售订单
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建客户模态框 -->
    <div class="modal fade" id="newCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新客户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="new-customer-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">客户编码 *</label>
                                <input type="text" class="form-control" name="customer_code" required id="new-customer-code" placeholder="例如: C001">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">客户名称 *</label>
                                <input type="text" class="form-control" name="customer_name" required placeholder="例如: 华润机械制造有限公司">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">联系人</label>
                                <input type="text" class="form-control" name="contact_person" placeholder="例如: 陈工">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">联系电话</label>
                                <input type="tel" class="form-control" name="phone" placeholder="例如: 13800138000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">电子邮箱</label>
                                <input type="email" class="form-control" name="email" placeholder="例如: contact@example.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">客户类型</label>
                                <select class="form-select" name="customer_type">
                                    <option value="终端客户" selected>终端客户</option>
                                    <option value="代理商">代理商</option>
                                    <option value="经销商">经销商</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">地址</label>
                                <textarea class="form-control" name="address" rows="2" placeholder="详细地址"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">信用等级</label>
                                <select class="form-select" name="credit_level">
                                    <option value="高">高</option>
                                    <option value="中" selected>中</option>
                                    <option value="低">低</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">信用额度(元)</label>
                                <input type="number" class="form-control" name="credit_limit" value="100000" step="1000">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" name="notes" rows="2" placeholder="客户特殊要求或其他信息"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitNewCustomer()">
                        <i class="fas fa-save me-1"></i>保存客户
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建供应商模态框 -->
    <div class="modal fade" id="newSupplierModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新供应商</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="new-supplier-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">供应商编码 *</label>
                                <input type="text" class="form-control" name="supplier_code" required id="new-supplier-code" placeholder="例如: S001">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">供应商名称 *</label>
                                <input type="text" class="form-control" name="supplier_name" required placeholder="例如: 华东氟胶有限公司">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">联系人</label>
                                <input type="text" class="form-control" name="contact_person" placeholder="例如: 张经理">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">联系电话</label>
                                <input type="tel" class="form-control" name="phone" placeholder="例如: 13800138000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">电子邮箱</label>
                                <input type="email" class="form-control" name="email" placeholder="例如: sales@supplier.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">供应商评级</label>
                                <select class="form-select" name="rating">
                                    <option value="A">A级</option>
                                    <option value="B" selected>B级</option>
                                    <option value="C">C级</option>
                                    <option value="D">D级</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">地址</label>
                                <textarea class="form-control" name="address" rows="2" placeholder="供应商详细地址"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">主要供应产品</label>
                                <input type="text" class="form-control" name="main_products" placeholder="例如: 氟胶制品、密封件">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">合作起始日期</label>
                                <input type="date" class="form-control" name="cooperation_date">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" name="notes" rows="2" placeholder="供应商特殊要求或其他信息"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitNewSupplier()">
                        <i class="fas fa-save me-1"></i>保存供应商
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 库存调整模态框 -->
    <div class="modal fade" id="stockAdjustModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">库存调整</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stock-adjust-form">
                        <div class="mb-3">
                            <label class="form-label">产品</label>
                            <select class="form-select" id="adjust-product-select" required>
                                <option value="">选择产品</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">调整类型</label>
                            <select class="form-select" id="adjust-type" required>
                                <option value="增加">增加库存</option>
                                <option value="减少">减少库存</option>
                                <option value="设置">设置库存</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" id="adjust-quantity-label">调整数量</label>
                            <input type="number" class="form-control" id="adjust-quantity" required min="1" value="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">调整原因</label>
                            <select class="form-select" id="adjust-reason" required>
                                <option value="盘点差异">盘点差异</option>
                                <option value="损坏报废">损坏报废</option>
                                <option value="样品出库">样品出库</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">备注</label>
                            <textarea class="form-control" id="adjust-notes" rows="2" placeholder="调整的详细说明"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>当前库存: <span id="current-stock-display">0</span></small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitStockAdjust()">确认调整</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统信息模态框 -->
    <div class="modal fade" id="systemInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">系统信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-plug me-2"></i>连接状态</h6>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <p id="system-info-status">正在检查...</p>
                                    <p class="mb-0"><small>API地址: <span id="system-info-api-url">http://127.0.0.1:5000/api</span></small></p>
                                </div>
                            </div>

                            <h6><i class="fas fa-database me-2"></i>数据库信息</h6>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <p id="system-info-database">正在检查...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-network-wired me-2"></i>API端点</h6>
                            <div class="card">
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0" id="system-info-endpoints">
                                        <li><i class="fas fa-check text-success me-2"></i>产品管理: <code>/api/products</code></li>
                                        <li><i class="fas fa-check text-success me-2"></i>库存管理: <code>/api/inventory</code></li>
                                        <li><i class="fas fa-check text-success me-2"></i>采购管理: <code>/api/purchase</code></li>
                                        <li><i class="fas fa-check text-success me-2"></i>销售管理: <code>/api/sales</code></li>
                                        <li><i class="fas fa-check text-success me-2"></i>客户管理: <code>/api/customers</code></li>
                                        <li><i class="fas fa-check text-success me-2"></i>供应商管理: <code>/api/suppliers</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.zh-CN.min.js"></script>

    <script>
        // ==================== 全局变量和配置 ====================
        let API_BASE = 'http://127.0.0.1:5000/api';
        let currentTab = 'dashboard';
        let currentPage = 1;
        let totalPages = 1;
        let connectionStatus = false;
        let productsData = [];
        let customersData = [];
        let suppliersData = [];
        let purchaseOrdersData = [];
        let salesOrdersData = [];
        let chartsInitialized = false;
        let purchaseItems = [];
        let salesItems = [];

        // ==================== 工具函数 ====================
        function sanitizeProductData(products) {
            if (!products || !Array.isArray(products)) return [];

            return products.map(product => ({
                ...product,
                unit_price: parseFloat(product.unit_price) || 0,
                current_stock: parseInt(product.current_stock) || 0,
                min_stock_level: parseInt(product.min_stock_level) || 10,
                max_stock_level: parseInt(product.max_stock_level) || 1000,
                safety_stock: parseInt(product.safety_stock) || 50
            }));
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function updateConnectionStatus(status, message) {
            connectionStatus = status;
            const statusElement = document.getElementById('connection-status');
            const textElement = document.getElementById('connection-text');
            const apiStatusElement = document.getElementById('api-status');

            if (status) {
                statusElement.className = 'connection-status connection-connected';
                textElement.textContent = '已连接';
                apiStatusElement.innerHTML = '<i class="fas fa-check-circle"></i> 已连接';
                apiStatusElement.className = 'text-success';
            } else {
                statusElement.className = 'connection-status connection-disconnected';
                textElement.textContent = message || '未连接';
                apiStatusElement.innerHTML = '<i class="fas fa-times-circle"></i> 未连接';
                apiStatusElement.className = 'text-danger';
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }

        function formatCurrency(amount) {
            return '¥' + parseFloat(amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function generateCode(prefix, length = 3) {
            const randomNum = Math.floor(Math.random() * Math.pow(10, length));
            return `${prefix}${randomNum.toString().padStart(length, '0')}`;
        }

        // ==================== 页面初始化和标签页切换 ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('工厂库存管理系统 v2.0 初始化...');

            // 更新API显示
            document.getElementById('current-api-url').textContent = API_BASE;
            document.getElementById('api-url').value = API_BASE;
            document.getElementById('system-info-api-url').textContent = API_BASE;

            // 设置日期控件的默认值
            const today = new Date().toISOString().split('T')[0];
            const oneWeekLater = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            document.getElementById('purchase-order-date').value = today;
            document.getElementById('purchase-delivery-date').value = oneWeekLater;
            document.getElementById('sales-order-date').value = today;

            // 初始化报告日期
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 6);
            document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = today;

            // 初始化标签页切换
            initTabSwitching();

            // 初始化图表
            initCharts();

            // 测试连接
            testConnection().then(() => {
                // 加载初始数据
                loadDashboardData();
                loadCategories();
                loadSuppliersForSelect();
                loadCustomersForSelect();
                loadProductsForSelect();
            });

            // 侧边栏切换按钮
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                const sidebar = document.querySelector('.sidebar');
                const contentArea = document.querySelector('.content-area');
                const sidebarTitle = document.querySelector('.sidebar-title');

                if (sidebar.style.width === '70px') {
                    sidebar.style.width = '250px';
                    contentArea.style.marginLeft = '250px';
                    sidebarTitle.style.display = 'inline';
                } else {
                    sidebar.style.width = '70px';
                    contentArea.style.marginLeft = '70px';
                    sidebarTitle.style.display = 'none';
                }
            });

            // 库存调整类型变化事件
            document.getElementById('adjust-type').addEventListener('change', function() {
                const label = document.getElementById('adjust-quantity-label');
                const type = this.value;

                if (type === '设置') {
                    label.textContent = '设置库存数量';
                } else if (type === '增加') {
                    label.textContent = '增加数量';
                } else {
                    label.textContent = '减少数量';
                }
            });

            // 产品选择变化事件
            document.getElementById('adjust-product-select').addEventListener('change', function() {
                const productId = this.value;
                if (productId) {
                    const product = productsData.find(p => p.product_id == productId);
                    if (product) {
                        document.getElementById('current-stock-display').textContent = product.current_stock;
                    }
                }
            });

            console.log('系统初始化完成');
        });

        function initTabSwitching() {
            const tabLinks = document.querySelectorAll('.sidebar .nav-link');

            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    // 移除所有active类
                    tabLinks.forEach(l => l.classList.remove('active'));

                    // 添加当前active类
                    this.classList.add('active');

                    // 获取目标标签页ID
                    const targetId = this.getAttribute('data-target');
                    currentTab = targetId;

                    // 更新页面标题
                    updatePageTitle(targetId);

                    // 切换到对应的标签页
                    switchTab(targetId);

                    // 加载对应标签页的数据
                    loadTabData(targetId);
                });
            });
        }

        function switchTab(tabId) {
            // 隐藏所有标签页
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabPanes.forEach(pane => {
                pane.classList.remove('active');
            });

            // 显示目标标签页
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        function updatePageTitle(tabId) {
            const tabTitles = {
                'dashboard': { title: '仪表盘', subtitle: '实时监控系统运行状态' },
                'products': { title: '产品管理', subtitle: '管理产品信息和规格' },
                'inventory': { title: '库存管理', subtitle: '监控库存状态和调整' },
                'purchase': { title: '采购管理', subtitle: '管理采购订单和供应商' },
                'sales': { title: '销售管理', subtitle: '管理销售订单和客户' },
                'customers': { title: '客户管理', subtitle: '管理客户信息和关系' },
                'suppliers': { title: '供应商管理', subtitle: '管理供应商信息和评级' },
                'reports': { title: '统计报表', subtitle: '查看数据分析和报告' },
                'system': { title: '系统设置', subtitle: '配置系统参数和选项' }
            };

            const tabInfo = tabTitles[tabId] || { title: '未知页面', subtitle: '' };
            document.getElementById('page-title').textContent = tabInfo.title;
            document.getElementById('page-subtitle').textContent = tabInfo.subtitle;
        }

        function loadTabData(tabId) {
            switch(tabId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'products':
                    loadProducts(1);
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'purchase':
                    loadPurchaseOrders(1);
                    break;
                case 'sales':
                    loadSalesOrders(1);
                    break;
                case 'customers':
                    loadCustomers(1);
                    break;
                case 'suppliers':
                    loadSuppliers(1);
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'system':
                    loadSystemInfo();
                    break;
            }
        }

        // ==================== 连接测试 ====================
        async function testConnection() {
            try {
                showLoading(true);
                console.log('测试API连接:', API_BASE);

                const res = await fetch(`${API_BASE}/test`);

                if (res.ok) {
                    const data = await res.json();
                    console.log('API测试成功:', data);

                    updateConnectionStatus(true, 'API连接正常');

                    // 显示成功消息
                    alert(`✅ API连接成功！\n\n状态: ${data.message}\n数据库: ${data.database || '已连接'}\n版本: ${data.version || '1.0.0'}`);

                    // 更新API版本信息
                    if (data.version) {
                        document.getElementById('api-version').textContent = '1.0.0';
                        document.getElementById('db-version').textContent = 'MySQL 8.0';
                    }

                    return true;
                } else {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
            } catch (error) {
                console.error('API连接测试失败:', error);
                updateConnectionStatus(false, '连接失败');

                alert(`❌ API连接失败！\n\n错误: ${error.message}\n\n请检查:\n1. Flask服务是否正在运行\n2. API地址是否正确: ${API_BASE}\n3. 在浏览器中访问: ${API_BASE.replace('/api', '/api/test')}`);

                return false;
            } finally {
                showLoading(false);
            }
        }

        // ==================== 仪表盘数据加载 ====================
        async function loadDashboardData() {
            try {
                console.log('加载仪表盘数据...');
                showLoading(true);

                // 并行加载数据
                const [productsRes, alertsRes, transactionsRes, salesRes, purchaseRes] = await Promise.allSettled([
                    fetch(`${API_BASE}/products?limit=100`),
                    fetch(`${API_BASE}/inventory/alerts`),
                    fetch(`${API_BASE}/inventory/transactions?limit=10`),
                    fetch(`${API_BASE}/statistics/sales`),
                    fetch(`${API_BASE}/purchase/orders/pending`)
                ]);

                // 处理产品数据
                if (productsRes.status === 'fulfilled' && productsRes.value.ok) {
                    const productsData = await productsRes.value.json();
                    const products = sanitizeProductData(productsData.data);

                    // 计算统计值
                    const stats = calculateDashboardStats(products);

                    // 更新统计卡片
                    updateDashboardStats(stats);
                }

                // 处理库存预警
                if (alertsRes.status === 'fulfilled' && alertsRes.value.ok) {
                    const alerts = await alertsRes.value.json();
                    updateAlertsTable(alerts);
                }

                // 处理销售统计
if (salesRes.status === 'fulfilled' && salesRes.value.ok) {
    const salesData = await salesRes.value.json();
    updateSalesStats(salesData);

    // 绘制图表 - 使用模拟数据或调整数据结构
    if (salesData.monthly && salesData.monthly.length > 0) {
        drawSalesChart(salesData.monthly);
    }

    if (salesData.by_category && salesData.by_category.length > 0) {
        drawCategoryChart(salesData.by_category);
    }
} else {
    // 使用模拟数据
    showSampleChartData();
}

// 处理待处理采购订单
if (purchaseRes.status === 'fulfilled' && purchaseRes.value.ok) {
    const pendingData = await purchaseRes.value.json();
    document.getElementById('stat-pending-purchase').textContent = pendingData.pending_count || 0;
} else {
    document.getElementById('stat-pending-purchase').textContent = '0';
}

// 处理待处理销售订单
document.getElementById('stat-pending-sales').textContent = '0';
document.getElementById('stat-pending-orders').textContent =
    (parseInt(document.getElementById('stat-pending-purchase').textContent) || 0) +
    (parseInt(document.getElementById('stat-pending-sales').textContent) || 0);

                // 显示模拟数据
                showSampleChartData();

            } finally {
                showLoading(false);
            }
        }

        function calculateDashboardStats(products) {
            let totalValue = 0;
            let totalItems = 0;
            let fluorValue = 0;
            let gasketValue = 0;
            let lowStockCount = 0;
            let totalProducts = 0;

            products.forEach(product => {
                const itemValue = product.current_stock * product.unit_price;
                totalValue += itemValue;
                totalItems += product.current_stock;
                totalProducts++;

                if (product.material_type === '氟胶') {
                    fluorValue += itemValue;
                } else if (product.material_type === '垫片') {
                    gasketValue += itemValue;
                }

                if (product.current_stock < product.min_stock_level) {
                    lowStockCount++;
                }
            });

            return {
                totalValue,
                totalItems,
                fluorValue,
                gasketValue,
                lowStockCount,
                totalProducts
            };
        }

        function updateDashboardStats(stats) {
            document.getElementById('stat-total-value').textContent = stats.totalValue.toFixed(2);
            document.getElementById('stat-total-items').textContent = stats.totalItems;
            document.getElementById('stat-alerts').textContent = stats.lowStockCount;
            document.getElementById('stat-low-stock').textContent = stats.lowStockCount;
            document.getElementById('total-products').textContent = stats.totalProducts;
            document.getElementById('total-inventory').textContent = stats.totalValue.toFixed(2);

            // 更新库存预警数量
            document.getElementById('alert-count').textContent = stats.lowStockCount;
            document.getElementById('alert-count').style.display = stats.lowStockCount > 0 ? 'flex' : 'none';
        }

        function updateAlertsTable(alerts) {
            // 更新预警数量
            const alertCount = alerts.length;
            document.getElementById('alert-count').textContent = alertCount;
            document.getElementById('alert-count').style.display = alertCount > 0 ? 'flex' : 'none';

            // 填充预警表格
            const alertsTbody = document.querySelector('#alerts-table tbody');
            alertsTbody.innerHTML = '';

            if (alerts.length === 0) {
                alertsTbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                            <p>暂无库存预警</p>
                        </td>
                    </tr>
                `;
            } else {
                alerts.slice(0, 5).forEach(alert => {
                    const badgeClass = alert.alert_type === '库存不足' ? 'badge bg-danger' : 'badge bg-warning';
                    const badgeText = alert.alert_type === '库存不足' ? '不足' : '过剩';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${alert.product_code}</td>
                        <td>${alert.product_name}</td>
                        <td>${alert.current_stock}</td>
                        <td><span class="${badgeClass}">${badgeText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="adjustStock(${alert.product_id})">
                                <i class="fas fa-edit"></i> 调整
                            </button>
                        </td>
                    `;
                    alertsTbody.appendChild(row);
                });
            }
        }

        function updateTransactionsTable(transactions) {
            // 填充变动记录表格
            const transTbody = document.querySelector('#transactions-table tbody');
            transTbody.innerHTML = '';

            if (transactions.length === 0) {
                transTbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-history fa-2x mb-3"></i>
                            <p>暂无库存变动记录</p>
                        </td>
                    </tr>
                `;
            } else {
                transactions.slice(0, 10).forEach(trans => {
                    const date = new Date(trans.transaction_date).toLocaleString('zh-CN');
                    const changeClass = trans.quantity_change > 0 ? 'text-success' : 'text-danger';
                    const changeSign = trans.quantity_change > 0 ? '+' : '';
                    const typeClass = trans.transaction_type === '采购入库' ? 'badge bg-success' :
                                    trans.transaction_type === '销售出库' ? 'badge bg-danger' :
                                    trans.transaction_type === '库存调整' ? 'badge bg-info' : 'badge bg-secondary';
                    const typeText = trans.transaction_type === '采购入库' ? '采购' :
                                   trans.transaction_type === '销售出库' ? '销售' :
                                   trans.transaction_type === '库存调整' ? '调整' : '其他';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><small>${date}</small></td>
                        <td><small>${trans.product_name}</small></td>
                        <td><span class="${typeClass}">${typeText}</span></td>
                        <td class="${changeClass} fw-bold">${changeSign}${trans.quantity_change}</td>
                        <td>${trans.quantity_after}</td>
                    `;
                    transTbody.appendChild(row);
                });
            }
        }

        function updateSalesStats(salesData) {
    // 更新销售统计
    if (salesData.monthly && salesData.monthly.length > 0) {
        const currentMonth = salesData.monthly[0];
        document.getElementById('stat-month-sales').textContent = currentMonth.total_amount ? currentMonth.total_amount.toFixed(2) : '0';

        // 计算增长率
        if (salesData.monthly.length > 1) {
            const prevMonth = salesData.monthly[1];
            const growth = prevMonth.total_amount > 0 ?
                ((currentMonth.total_amount - prevMonth.total_amount) / prevMonth.total_amount * 100).toFixed(1) : '100';
            document.getElementById('stat-sales-growth').textContent = `${growth}%`;
        }
    } else {
        document.getElementById('stat-month-sales').textContent = '0';
        document.getElementById('stat-sales-growth').textContent = '0%';
    }

    // 更新待处理销售订单
    document.getElementById('stat-pending-sales').textContent = '0';
    document.getElementById('stat-pending-orders').textContent =
        (parseInt(document.getElementById('stat-pending-purchase').textContent) || 0) +
        0;
}

        // ==================== 图表函数 ====================
        function initCharts() {
            console.log('初始化图表...');

            // 检查图表容器是否存在
            const salesChartCanvas = document.getElementById('salesChart');
            const categoryChartCanvas = document.getElementById('categoryChart');

            if (salesChartCanvas) {
                createPlaceholderChart('salesChart', 'line', ['暂无数据'], [0]);
            }

            if (categoryChartCanvas) {
                createPlaceholderChart('categoryChart', 'doughnut', ['暂无数据'], [1]);
            }

            if (document.getElementById('reportChart')) {
                createPlaceholderChart('reportChart', 'bar', ['暂无数据'], [0]);
            }

            if (document.getElementById('purchaseChart')) {
                createPlaceholderChart('purchaseChart', 'pie', ['暂无数据'], [1]);
            }

            if (document.getElementById('inventoryChart')) {
                createPlaceholderChart('inventoryChart', 'line', ['暂无数据'], [0]);
            }

            chartsInitialized = true;
        }

        function createPlaceholderChart(canvasId, type, labels, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;

            try {
                return new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: type === 'doughnut' || type === 'pie' ?
                                ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'] :
                                undefined,
                            borderColor: type === 'line' || type === 'bar' ? '#3498db' : undefined,
                            borderWidth: type === 'line' || type === 'bar' ? 2 : 1,
                            fill: type === 'line'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: type === 'doughnut' || type === 'pie'
                            },
                            tooltip: {
                                enabled: data[0] > 0
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`创建占位图表${canvasId}失败:`, error);
                return null;
            }
        }

        function drawSalesChart(monthlyData) {
            try {
                const ctx = document.getElementById('salesChart');
                if (!ctx) {
                    console.error('销售图表容器不存在');
                    return;
                }

                console.log('绘制销售图表，数据量:', monthlyData.length);

                // 准备数据
                const reversedData = [...monthlyData].reverse();
                const labels = reversedData.map(d => d.month);
                const data = reversedData.map(d => d.total_amount || 0);

                // 如果已有图表实例，更新数据
                if (window.salesChart && window.salesChart instanceof Chart) {
                    window.salesChart.data.labels = labels;
                    window.salesChart.data.datasets[0].data = data;
                    window.salesChart.update();
                } else {
                    // 创建新图表
                    window.salesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '销售额 (元)',
                                data: data,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: '#3498db',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return `销售额: ${formatCurrency(context.parsed.y)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'nearest'
                            }
                        }
                    });
                }

                console.log('销售图表绘制完成');
            } catch (error) {
                console.error('绘制销售图表失败:', error);
            }
        }

        function drawCategoryChart(categoryData) {
            try {
                const ctx = document.getElementById('categoryChart');
                if (!ctx) {
                    console.error('类别图表容器不存在');
                    return;
                }

                console.log('绘制类别图表，数据量:', categoryData.length);

                // 准备数据
                const labels = categoryData.map(d => d.material_type || '其他');
                const data = categoryData.map(d => d.total_amount || 0);
                const backgroundColors = [
                    '#3498db', '#2ecc71', '#e74c3c', '#f39c12',
                    '#9b59b6', '#1abc9c', '#d35400', '#34495e'
                ];

                // 如果已有图表实例，更新数据
                if (window.categoryChart && window.categoryChart instanceof Chart) {
                    window.categoryChart.data.labels = labels;
                    window.categoryChart.data.datasets[0].data = data;
                    window.categoryChart.data.datasets[0].backgroundColor = backgroundColors.slice(0, labels.length);
                    window.categoryChart.update();
                } else {
                    // 创建新图表
                    window.categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: backgroundColors.slice(0, labels.length),
                                borderWidth: 1,
                                borderColor: '#fff',
                                hoverOffset: 15
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        padding: 20,
                                        font: {
                                            size: 11
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            cutout: '60%'
                        }
                    });
                }

                console.log('类别图表绘制完成');
            } catch (error) {
                console.error('绘制类别图表失败:', error);
            }
        }

        function setChartRange(months) {
            alert(`已设置为最近${months}个月的数据`);
            // 这里可以添加实际的数据过滤逻辑
            loadDashboardData();
        }

        function showSampleChartData() {
            console.log('显示模拟图表数据');

            // 模拟销售数据
            const sampleSalesData = [
                { month: '2024-01', total_amount: 12000 },
                { month: '2024-02', total_amount: 18000 },
                { month: '2024-03', total_amount: 15000 },
                { month: '2024-04', total_amount: 22000 },
                { month: '2024-05', total_amount: 19000 },
                { month: '2024-06', total_amount: 25000 }
            ];

            // 模拟类别数据
            const sampleCategoryData = [
                { material_type: '氟胶', total_amount: 45000 },
                { material_type: '垫片', total_amount: 32000 },
                { material_type: '其他', total_amount: 12000 }
            ];

            // 绘制模拟图表
            drawSalesChart(sampleSalesData);
            drawCategoryChart(sampleCategoryData);

            // 更新统计卡片中的模拟数据
            document.getElementById('stat-month-sales').textContent = '25000';
            document.getElementById('stat-sales-growth').textContent = '+31.6%';
        }

        // ==================== 产品管理功能 ====================
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/categories`);
                if (res.ok) {
                    const categories = await res.json();
                    const select = document.getElementById('product-category-select');
                    const filterSelect = document.getElementById('filter-category');

                    // 清空现有选项
                    select.innerHTML = '<option value="">选择类别</option>';
                    filterSelect.innerHTML = '<option value="">全部类别</option>';

                    // 添加新选项
                    categories.forEach(cat => {
                        const option1 = document.createElement('option');
                        option1.value = cat.category_id;
                        option1.textContent = cat.category_name;
                        select.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = cat.category_id;
                        option2.textContent = cat.category_name;
                        filterSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('加载产品类别失败:', error);
            }
        }

        async function loadProducts(page = 1) {
            try {
                showLoading(true);

                const material = document.getElementById('filter-material').value;
                const category = document.getElementById('filter-category').value;
                const status = document.getElementById('filter-status').value;
                const search = document.getElementById('search-product').value;

                let url = `${API_BASE}/products?page=${page}&limit=15`;
                if (material) url += `&material_type=${material}`;
                if (category) url += `&category_id=${category}`;
                if (status) url += `&status=${status}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                productsData = sanitizeProductData(data.data);

                // 填充产品表格
                const tbody = document.querySelector('#products-table tbody');
                tbody.innerHTML = '';

                if (productsData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-box-open fa-2x mb-3"></i>
                                <p>暂无产品数据</p>
                                <button class="btn btn-primary btn-sm" onclick="showNewProductModal()">
                                    <i class="fas fa-plus me-1"></i>添加第一个产品
                                </button>
                            </td>
                        </tr>
                    `;
                } else {
                    productsData.forEach(product => {
                        const materialBadge = product.material_type === '氟胶' ?
                            '<span class="material-badge material-fluor">氟胶</span>' :
                            product.material_type === '垫片' ?
                            '<span class="material-badge material-gasket">垫片</span>' :
                            '<span class="material-badge material-other">其他</span>';

                        const statusBadge = product.status === '正常' ?
                            '<span class="status-badge status-active">正常</span>' :
                            '<span class="status-badge status-inactive">停用</span>';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${product.product_code}</strong></td>
                            <td>${product.product_name}</td>
                            <td>${product.category_name || '-'}</td>
                            <td>${materialBadge}</td>
                            <td><small class="text-muted">${product.specification || '-'}</small></td>
                            <td>${formatCurrency(product.unit_price)}</td>
                            <td>
                                <span class="${product.current_stock < product.min_stock_level ? 'text-danger fw-bold' : ''}">
                                    ${product.current_stock}
                                </span>
                            </td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-action-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.product_id})" title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewProduct(${product.product_id})" title="查看">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.product_id})" title="删除">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // 更新分页
                currentPage = page;
                totalPages = data.total_pages || 1;
                updatePagination('products-pagination', page, totalPages, loadProducts);

            } catch (error) {
                console.error('加载产品列表失败:', error);
                const tbody = document.querySelector('#products-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>加载失败: ${error.message}</p>
                            <button class="btn btn-outline-secondary btn-sm" onclick="testConnection()">
                                <i class="fas fa-plug me-1"></i>测试连接
                            </button>
                        </td>
                    </tr>
                `;
            } finally {
                showLoading(false);
            }
        }

        function showNewProductModal() {
            // 生成产品编码
            const productCode = generateCode('P', 3);
            document.getElementById('new-product-code').value = productCode;

            const modal = new bootstrap.Modal(document.getElementById('newProductModal'));
            document.getElementById('new-product-form').reset();
            modal.show();
        }

        async function submitNewProduct() {
            try {
                const form = document.getElementById('new-product-form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                console.log("提交产品数据:", data);

                // 验证必要字段
                if (!data.product_code || !data.product_name || !data.material_type || !data.unit_price) {
                    alert('请填写所有必填字段（产品编码、名称、材料类型、单价）');
                    return;
                }

                // 转换数据类型
                data.unit_price = parseFloat(data.unit_price);
                data.current_stock = parseInt(data.current_stock) || 0;
                data.min_stock_level = parseInt(data.min_stock_level) || 10;
                data.max_stock_level = parseInt(data.max_stock_level) || 1000;
                data.safety_stock = parseInt(data.safety_stock) || 50;

                if (data.category_id) {
                    data.category_id = parseInt(data.category_id);
                }

                console.log("转换后数据:", data);

                showLoading(true);

                // 发送创建产品请求
                const res = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log("响应状态:", res.status, res.statusText);

                if (res.ok) {
                    const result = await res.json();
                    console.log("创建成功:", result);

                    alert(`✅ 产品创建成功！\n产品ID: ${result.product_id}\n产品编码: ${result.product_code}`);

                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('newProductModal')).hide();

                    // 刷新数据
                    if (currentTab === 'products') {
                        loadProducts(currentPage);
                    }

                    loadDashboardData();
                    loadProductsForSelect();

                } else {
                    const error = await res.json();
                    console.error("创建失败:", error);
                    alert(`❌ 创建失败: ${error.error || '未知错误'}\n\n请检查:\n1. 数据库连接\n2. 产品编码是否重复\n3. 所有必填字段是否已填写`);
                }

            } catch (error) {
                console.error('创建产品失败:', error);
                alert(`❌ 创建产品失败: ${error.message}\n\n请检查网络连接和API服务状态`);
            } finally {
                showLoading(false);
            }
        }

        async function editProduct(productId) {
            try {
                showLoading(true);

                // 获取产品详情
                const res = await fetch(`${API_BASE}/products/${productId}`);
                if (!res.ok) {
                    throw new Error('获取产品信息失败');
                }

                const product = await res.json();

                // 确保数据类型的正确性
                product.unit_price = parseFloat(product.unit_price) || 0;
                product.current_stock = parseInt(product.current_stock) || 0;
                product.min_stock_level = parseInt(product.min_stock_level) || 10;
                product.max_stock_level = parseInt(product.max_stock_level) || 1000;
                product.safety_stock = parseInt(product.safety_stock) || 50;

                // 创建编辑模态框HTML
                const modalHtml = `
                    <div class="modal fade" id="editProductModalInstance" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">编辑产品 - ${product.product_code}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="edit-product-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">产品编码</label>
                                                <input type="text" class="form-control" value="${product.product_code}" disabled>
                                                <small class="text-muted">产品编码不可修改</small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">产品名称 *</label>
                                                <input type="text" class="form-control" name="product_name" value="${product.product_name}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">材料类型 *</label>
                                                <select class="form-select" name="material_type" required>
                                                    <option value="氟胶" ${product.material_type === '氟胶' ? 'selected' : ''}>氟胶</option>
                                                    <option value="垫片" ${product.material_type === '垫片' ? 'selected' : ''}>垫片</option>
                                                    <option value="其他" ${product.material_type === '其他' ? 'selected' : ''}>其他</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">单价 (元) *</label>
                                                <input type="number" class="form-control" name="unit_price" value="${product.unit_price}" step="0.01" required>
                                            </div>
                                            <div class="col-md-12 mb-3">
                                                <label class="form-label">规格描述</label>
                                                <textarea class="form-control" name="specification" rows="2">${product.specification || ''}</textarea>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">当前库存</label>
                                                <input type="number" class="form-control" name="current_stock" value="${product.current_stock}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">最低库存</label>
                                                <input type="number" class="form-control" name="min_stock_level" value="${product.min_stock_level}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">最高库存</label>
                                                <input type="number" class="form-control" name="max_stock_level" value="${product.max_stock_level}">
                                            </div>
                                            <div class="col-md-12 mb-3">
                                                <label class="form-label">仓库位置</label>
                                                <input type="text" class="form-control" name="warehouse_location" value="${product.warehouse_location || ''}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">状态</label>
                                                <select class="form-select" name="status">
                                                    <option value="正常" ${product.status === '正常' ? 'selected' : ''}>正常</option>
                                                    <option value="停用" ${product.status === '停用' ? 'selected' : ''}>停用</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">安全库存</label>
                                                <input type="number" class="form-control" name="safety_stock" value="${product.safety_stock || 50}">
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="updateProduct(${product.product_id})">保存修改</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 移除旧的模态框（如果有）
                const oldModal = document.getElementById('editProductModalInstance');
                if (oldModal) oldModal.remove();

                // 添加新的模态框
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('editProductModalInstance'));
                modal.show();

            } catch (error) {
                console.error('编辑产品失败:', error);
                alert('编辑产品失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function updateProduct(productId) {
            try {
                const form = document.getElementById('edit-product-form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // 转换数据类型
                data.unit_price = parseFloat(data.unit_price);
                data.current_stock = parseInt(data.current_stock) || 0;
                data.min_stock_level = parseInt(data.min_stock_level) || 10;
                data.max_stock_level = parseInt(data.max_stock_level) || 1000;
                data.safety_stock = parseInt(data.safety_stock) || 50;

                console.log("更新产品数据:", data);

                showLoading(true);

                const res = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    const result = await res.json();
                    alert('✅ 产品更新成功！');

                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModalInstance'));
                    modal.hide();

                    // 移除模态框元素
                    setTimeout(() => {
                        const modalElement = document.getElementById('editProductModalInstance');
                        if (modalElement) modalElement.remove();
                    }, 300);

                    // 刷新数据
                    if (currentTab === 'products') {
                        loadProducts(currentPage);
                    }

                    loadDashboardData();
                    loadProductsForSelect();

                } else {
                    const error = await res.json();
                    alert(`❌ 更新失败: ${error.error || '未知错误'}`);
                }

            } catch (error) {
                console.error('更新产品失败:', error);
                alert('更新产品失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function viewProduct(productId) {
            try {
                showLoading(true);

                // 获取产品详情
                const res = await fetch(`${API_BASE}/products/${productId}`);
                if (!res.ok) {
                    throw new Error('获取产品信息失败');
                }

                const product = await res.json();

                // 确保数据类型的正确性
                product.unit_price = parseFloat(product.unit_price) || 0;
                product.current_stock = parseInt(product.current_stock) || 0;
                product.min_stock_level = parseInt(product.min_stock_level) || 10;
                product.max_stock_level = parseInt(product.max_stock_level) || 1000;
                product.safety_stock = parseInt(product.safety_stock) || 50;

                // 获取产品的库存变动记录
                const transRes = await fetch(`${API_BASE}/inventory/transactions?product_id=${productId}&limit=5`);
                let transactions = [];
                if (transRes.ok) {
                    transactions = await transRes.json();
                }

                // 创建详情模态框HTML
                const modalHtml = `
                    <div class="modal fade" id="viewProductModalInstance" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">产品详情 - ${product.product_code}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>基本信息</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <th width="40%">产品编码:</th>
                                                    <td>${product.product_code}</td>
                                                </tr>
                                                <tr>
                                                    <th>产品名称:</th>
                                                    <td>${product.product_name}</td>
                                                </tr>
                                                <tr>
                                                    <th>材料类型:</th>
                                                    <td>
                                                        ${product.material_type === '氟胶' ?
                                                            '<span class="material-badge material-fluor">氟胶</span>' :
                                                            product.material_type === '垫片' ?
                                                            '<span class="material-badge material-gasket">垫片</span>' :
                                                            '<span class="material-badge material-other">其他</span>'}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>产品类别:</th>
                                                    <td>${product.category_name || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <th>规格描述:</th>
                                                    <td>${product.specification || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <th>计量单位:</th>
                                                    <td>${product.unit || '个'}</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>库存信息</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <th width="40%">当前库存:</th>
                                                    <td class="${product.current_stock < product.min_stock_level ? 'text-danger fw-bold' : ''}">
                                                        ${product.current_stock}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>最低库存:</th>
                                                    <td>${product.min_stock_level}</td>
                                                </tr>
                                                <tr>
                                                    <th>最高库存:</th>
                                                    <td>${product.max_stock_level}</td>
                                                </tr>
                                                <tr>
                                                    <th>安全库存:</th>
                                                    <td>${product.safety_stock || 50}</td>
                                                </tr>
                                                <tr>
                                                    <th>单价:</th>
                                                    <td>${formatCurrency(product.unit_price)}</td>
                                                </tr>
                                                <tr>
                                                    <th>库存价值:</th>
                                                    <td>${formatCurrency(product.current_stock * product.unit_price)}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <h6>其他信息</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <th width="20%">仓库位置:</th>
                                                    <td>${product.warehouse_location || '未指定'}</td>
                                                </tr>
                                                <tr>
                                                    <th>状态:</th>
                                                    <td>${product.status === '正常' ?
                                                        '<span class="status-badge status-active">正常</span>' :
                                                        '<span class="status-badge status-inactive">停用</span>'}</td>
                                                </tr>
                                                <tr>
                                                    <th>创建时间:</th>
                                                    <td>${new Date(product.created_at).toLocaleString('zh-CN')}</td>
                                                </tr>
                                                <tr>
                                                    <th>更新时间:</th>
                                                    <td>${new Date(product.updated_at).toLocaleString('zh-CN')}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>

                                    ${transactions.length > 0 ? `
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <h6>最近库存变动</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>时间</th>
                                                            <th>类型</th>
                                                            <th>变动量</th>
                                                            <th>结存</th>
                                                            <th>备注</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${transactions.map(trans => `
                                                            <tr>
                                                                <td><small>${new Date(trans.transaction_date).toLocaleString('zh-CN')}</small></td>
                                                                <td><span class="badge ${trans.transaction_type === '采购入库' ? 'bg-success' :
                                                                                           trans.transaction_type === '销售出库' ? 'bg-danger' :
                                                                                           'bg-info'}">${trans.transaction_type}</span></td>
                                                                <td class="${trans.quantity_change > 0 ? 'text-success' : 'text-danger'}">
                                                                    ${trans.quantity_change > 0 ? '+' : ''}${trans.quantity_change}
                                                                </td>
                                                                <td>${trans.quantity_after}</td>
                                                                <td><small>${trans.notes || '-'}</small></td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    ` : ''}

                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                <button class="btn btn-primary me-md-2" onclick="editProduct(${product.product_id})">
                                                    <i class="fas fa-edit me-1"></i>编辑产品
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="adjustStock(${product.product_id})">
                                                    <i class="fas fa-warehouse me-1"></i>调整库存
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 移除旧的模态框（如果有）
                const oldModal = document.getElementById('viewProductModalInstance');
                if (oldModal) oldModal.remove();

                // 添加新的模态框
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('viewProductModalInstance'));
                modal.show();

            } catch (error) {
                console.error('查看产品失败:', error);
                alert('查看产品失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('⚠️  确定要删除这个产品吗？\n\n此操作将永久删除产品数据，包括相关的库存记录！')) {
                return;
            }

            try {
                showLoading(true);

                const res = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    const result = await res.json();
                    alert('✅ 产品删除成功！');

                    // 刷新数据
                    if (currentTab === 'products') {
                        loadProducts(currentPage);
                    }

                    loadDashboardData();
                    loadProductsForSelect();

                } else {
                    const error = await res.json();
                    alert(`❌ 删除失败: ${error.error || '未知错误'}`);
                }

            } catch (error) {
                console.error('删除产品失败:', error);
                alert('删除产品失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function exportProducts() {
            if (productsData.length === 0) {
                alert('没有产品数据可以导出');
                return;
            }

            // 创建CSV内容
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "产品编码,产品名称,材料类型,规格,单价,库存,最低库存,最高库存,安全库存,仓库位置,状态\n";

            productsData.forEach(product => {
                const row = [
                    product.product_code,
                    product.product_name,
                    product.material_type,
                    product.specification || '',
                    product.unit_price,
                    product.current_stock,
                    product.min_stock_level,
                    product.max_stock_level,
                    product.safety_stock || 50,
                    product.warehouse_location || '',
                    product.status
                ];
                csvContent += row.join(',') + "\n";
            });

            // 创建下载链接
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `产品列表_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('✅ 产品数据已导出为CSV文件');
        }

        function importProducts() {
            alert('产品导入功能正在开发中...\n\n暂时请通过"添加产品"功能手动添加产品');
        }

        // ==================== 库存管理功能 ====================
        async function loadInventory() {
            try {
                showLoading(true);

                // 获取所有产品数据
                const res = await fetch(`${API_BASE}/products?limit=100`);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                const products = sanitizeProductData(data.data);

                // 计算库存统计
                calculateInventoryStats(products);

                // 填充库存表格
                const tbody = document.querySelector('#inventory-table tbody');
                tbody.innerHTML = '';

                if (products.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-warehouse fa-2x mb-3"></i>
                                <p>暂无库存数据</p>
                            </td>
                        </tr>
                    `;
                } else {
                    products.forEach(product => {
                        // 确定库存状态
                        let stockStatus = '正常';
                        let statusClass = 'status-badge status-active';

                        if (product.current_stock < product.min_stock_level) {
                            stockStatus = '库存不足';
                            statusClass = 'status-badge status-pending';
                        } else if (product.current_stock > product.max_stock_level) {
                            stockStatus = '库存过剩';
                            statusClass = 'status-badge status-cancelled';
                        }

                        const materialBadge = product.material_type === '氟胶' ?
                            '<span class="material-badge material-fluor">氟胶</span>' :
                            product.material_type === '垫片' ?
                            '<span class="material-badge material-gasket">垫片</span>' :
                            '<span class="material-badge material-other">其他</span>';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${product.product_code}</strong></td>
                            <td>${product.product_name}</td>
                            <td>${materialBadge}</td>
                            <td class="${product.current_stock < product.min_stock_level ? 'text-danger fw-bold' : ''}">
                                ${product.current_stock}
                            </td>
                            <td>${product.min_stock_level}</td>
                            <td>${product.max_stock_level}</td>
                            <td><span class="${statusClass}">${stockStatus}</span></td>
                            <td>${product.warehouse_location || '-'}</td>
                            <td>
                                <div class="btn-action-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="adjustStock(${product.product_id})" title="调整库存">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewStockHistory(${product.product_id})" title="查看历史">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="purchaseStock(${product.product_id})" title="采购补货">
                                        <i class="fas fa-cart-plus"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

            } catch (error) {
                console.error('加载库存数据失败:', error);
                const tbody = document.querySelector('#inventory-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>加载失败: ${error.message}</p>
                        </td>
                    </tr>
                `;
            } finally {
                showLoading(false);
            }
        }

        function calculateInventoryStats(products) {
            let fluorTotal = 0;
            let fluorValue = 0;
            let fluorSafe = 0;
            let fluorAlert = 0;

            let gasketTotal = 0;
            let gasketValue = 0;
            let gasketSafe = 0;
            let gasketAlert = 0;

            let fluorTotalStock = 0;
            let gasketTotalStock = 0;

            products.forEach(product => {
                if (product.material_type === '氟胶') {
                    fluorTotal += product.current_stock * product.unit_price;
                    fluorTotalStock += product.current_stock;
                    fluorSafe += product.min_stock_level;

                    if (product.current_stock < product.min_stock_level) {
                        fluorAlert++;
                    }
                } else if (product.material_type === '垫片') {
                    gasketTotal += product.current_stock * product.unit_price;
                    gasketTotalStock += product.current_stock;
                    gasketSafe += product.min_stock_level;

                    if (product.current_stock < product.min_stock_level) {
                        gasketAlert++;
                    }
                }
            });

            // 更新氟胶制品统计
            document.getElementById('fluor-total-value').textContent = fluorTotal.toFixed(2);
            document.getElementById('fluor-total').textContent = fluorTotalStock;
            document.getElementById('fluor-safe').textContent = fluorSafe;
            document.getElementById('fluor-alert').textContent = fluorAlert;

            // 计算进度条百分比（基于总库存和最低库存的关系）
            const fluorPercent = fluorTotalStock > 0 ? Math.min(100, (fluorTotalStock / (fluorSafe * 1.5)) * 100) : 0;
            document.getElementById('fluor-progress').style.width = fluorPercent + '%';
            document.getElementById('fluor-percent').textContent = fluorPercent.toFixed(1) + '%';

            // 更新垫片制品统计
            document.getElementById('gasket-total-value').textContent = gasketTotal.toFixed(2);
            document.getElementById('gasket-total').textContent = gasketTotalStock;
            document.getElementById('gasket-safe').textContent = gasketSafe;
            document.getElementById('gasket-alert').textContent = gasketAlert;

            const gasketPercent = gasketTotalStock > 0 ? Math.min(100, (gasketTotalStock / (gasketSafe * 1.5)) * 100) : 0;
            document.getElementById('gasket-progress').style.width = gasketPercent + '%';
            document.getElementById('gasket-percent').textContent = gasketPercent.toFixed(1) + '%';
        }

        async function loadInventoryAlerts() {
            try {
                const res = await fetch(`${API_BASE}/inventory/alerts`);
                if (res.ok) {
                    const alerts = await res.json();
                    updateAlertsTable(alerts);
                }
            } catch (error) {
                console.error('加载库存预警失败:', error);
            }
        }

        async function loadInventoryTransactions() {
            try {
                const res = await fetch(`${API_BASE}/inventory/transactions?limit=50`);
                if (res.ok) {
                    const transactions = await res.json();

                    // 创建一个模态框显示全部记录
                    const modalHtml = `
                        <div class="modal fade" id="inventoryHistoryModal" tabindex="-1">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">库存变动记录</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>时间</th>
                                                        <th>产品编码</th>
                                                        <th>产品名称</th>
                                                        <th>类型</th>
                                                        <th>变动前</th>
                                                        <th>变动量</th>
                                                        <th>变动后</th>
                                                        <th>备注</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="inventory-history-body">
                                                    <!-- 动态生成 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // 移除旧的模态框
                    const oldModal = document.getElementById('inventoryHistoryModal');
                    if (oldModal) oldModal.remove();

                    // 添加新的模态框
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // 填充表格数据
                    const tbody = document.getElementById('inventory-history-body');
                    tbody.innerHTML = '';

                    if (transactions.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    暂无库存变动记录
                                </td>
                            </tr>
                        `;
                    } else {
                        transactions.forEach(trans => {
                            const date = new Date(trans.transaction_date).toLocaleString('zh-CN');
                            const changeClass = trans.quantity_change > 0 ? 'text-success' : 'text-danger';
                            const changeSign = trans.quantity_change > 0 ? '+' : '';
                            const typeClass = trans.transaction_type === '采购入库' ? 'badge bg-success' :
                                            trans.transaction_type === '销售出库' ? 'badge bg-danger' :
                                            trans.transaction_type === '库存调整' ? 'badge bg-info' : 'badge bg-secondary';
                            const typeText = trans.transaction_type === '采购入库' ? '采购' :
                                           trans.transaction_type === '销售出库' ? '销售' :
                                           trans.transaction_type === '库存调整' ? '调整' : '其他';

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><small>${date}</small></td>
                                <td>${trans.product_code}</td>
                                <td>${trans.product_name}</td>
                                <td><span class="${typeClass}">${typeText}</span></td>
                                <td>${trans.quantity_before}</td>
                                <td class="${changeClass} fw-bold">${changeSign}${trans.quantity_change}</td>
                                <td>${trans.quantity_after}</td>
                                <td><small>${trans.notes || '-'}</small></td>
                            `;
                            tbody.appendChild(row);
                        });
                    }

                    // 显示模态框
                    const modal = new bootstrap.Modal(document.getElementById('inventoryHistoryModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('加载库存变动记录失败:', error);
                alert('加载库存变动记录失败: ' + error.message);
            }
        }

        function showStockAdjustModal() {
            // 刷新产品选择列表
            loadProductsForSelect();

            const modal = new bootstrap.Modal(document.getElementById('stockAdjustModal'));
            document.getElementById('stock-adjust-form').reset();
            modal.show();
        }

        async function loadProductsForSelect() {
            try {
                const res = await fetch(`${API_BASE}/products?limit=100`);
                if (res.ok) {
                    const data = await res.json();
                    productsData = sanitizeProductData(data.data);

                    // 更新库存调整模态框的产品选择
                    const productSelect = document.getElementById('adjust-product-select');
                    const purchaseProductSelect = document.getElementById('purchase-product-select');
                    const salesProductSelect = document.getElementById('sales-product-select');

                    // 清空现有选项
                    [productSelect, purchaseProductSelect, salesProductSelect].forEach(select => {
                        if (select) {
                            select.innerHTML = '<option value="">选择产品</option>';
                        }
                    });

                    // 添加新选项
                    productsData.forEach(product => {
                        const optionText = `${product.product_code} - ${product.product_name} (库存: ${product.current_stock})`;

                        // 库存调整模态框
                        if (productSelect) {
                            const option = document.createElement('option');
                            option.value = product.product_id;
                            option.textContent = optionText;
                            productSelect.appendChild(option);
                        }

                        // 采购订单模态框
                        if (purchaseProductSelect) {
                            const option = document.createElement('option');
                            option.value = product.product_id;
                            option.textContent = optionText;
                            purchaseProductSelect.appendChild(option);
                        }

                        // 销售订单模态框
                        if (salesProductSelect) {
                            const option = document.createElement('option');
                            option.value = product.product_id;
                            option.textContent = optionText;
                            salesProductSelect.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('加载产品选择列表失败:', error);
            }
        }

        function adjustStock(productId) {
            // 如果提供了productId，直接选择该产品
            if (productId) {
                const productSelect = document.getElementById('adjust-product-select');
                if (productSelect) {
                    productSelect.value = productId;

                    // 触发change事件以更新当前库存显示
                    const event = new Event('change');
                    productSelect.dispatchEvent(event);
                }
            }

            const modal = new bootstrap.Modal(document.getElementById('stockAdjustModal'));
            modal.show();
        }

        async function submitStockAdjust() {
            try {
                const productId = document.getElementById('adjust-product-select').value;
                const adjustType = document.getElementById('adjust-type').value;
                const quantity = parseInt(document.getElementById('adjust-quantity').value);
                const reason = document.getElementById('adjust-reason').value;
                const notes = document.getElementById('adjust-notes').value;

                if (!productId || !quantity || quantity <= 0) {
                    alert('请选择产品并输入有效的调整数量');
                    return;
                }

                // 获取当前库存
                const product = productsData.find(p => p.product_id == productId);
                if (!product) {
                    alert('未找到对应的产品信息');
                    return;
                }

                let newQuantity = product.current_stock;

                // 根据调整类型计算新库存
                switch (adjustType) {
                    case '增加':
                        newQuantity = product.current_stock + quantity;
                        break;
                    case '减少':
                        if (quantity > product.current_stock) {
                            if (!confirm(`⚠️  减少数量(${quantity})大于当前库存(${product.current_stock})，是否继续？`)) {
                                return;
                            }
                        }
                        newQuantity = product.current_stock - quantity;
                        break;
                    case '设置':
                        newQuantity = quantity;
                        break;
                }

                if (newQuantity < 0) {
                    alert('库存不能为负数');
                    return;
                }

                const confirmMessage = `确认调整库存:\n\n产品: ${product.product_name}\n当前库存: ${product.current_stock}\n调整后: ${newQuantity}\n调整量: ${newQuantity - product.current_stock}\n原因: ${reason}`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                showLoading(true);

                // 发送库存调整请求
                const res = await fetch(`${API_BASE}/inventory/adjust`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: newQuantity,
                        notes: `${reason}: ${notes || '手动调整库存'}`
                    })
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(`✅ 库存调整成功！\n\n产品: ${result.product_id}\n调整前: ${result.old_stock}\n调整后: ${result.new_stock}\n变动: ${result.change > 0 ? '+' : ''}${result.change}`);

                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('stockAdjustModal')).hide();

                    // 刷新数据
                    if (currentTab === 'inventory') {
                        loadInventory();
                    }

                    loadDashboardData();
                    loadProductsForSelect();

                } else {
                    const error = await res.json();
                    alert(`❌ 库存调整失败: ${error.error || '未知错误'}`);
                }

            } catch (error) {
                console.error('库存调整失败:', error);
                alert('库存调整失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function viewStockHistory(productId) {
            try {
                showLoading(true);

                // 获取产品信息
                const productRes = await fetch(`${API_BASE}/products/${productId}`);
                if (!productRes.ok) {
                    throw new Error('获取产品信息失败');
                }
                const product = await productRes.json();

                // 获取库存变动记录
                const transRes = await fetch(`${API_BASE}/inventory/transactions?product_id=${productId}&limit=50`);
                let transactions = [];
                if (transRes.ok) {
                    transactions = await transRes.json();
                }

                // 创建历史记录模态框
                const modalHtml = `
                    <div class="modal fade" id="stockHistoryModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">库存历史 - ${product.product_name} (${product.product_code})</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>当前库存信息</h6>
                                                    <p class="mb-1"><small>当前库存:</small> <strong>${product.current_stock}</strong></p>
                                                    <p class="mb-1"><small>最低库存:</small> ${product.min_stock_level}</p>
                                                    <p class="mb-1"><small>最高库存:</small> ${product.max_stock_level}</p>
                                                    <p class="mb-0"><small>安全库存:</small> ${product.safety_stock || 50}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>库存趋势</h6>
                                                    <canvas id="stockHistoryChart" height="100"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>时间</th>
                                                    <th>类型</th>
                                                    <th>变动前</th>
                                                    <th>变动量</th>
                                                    <th>变动后</th>
                                                    <th>备注</th>
                                                </tr>
                                            </thead>
                                            <tbody id="stock-history-body">
                                                <!-- 动态生成 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 移除旧的模态框
                const oldModal = document.getElementById('stockHistoryModal');
                if (oldModal) oldModal.remove();

                // 添加新的模态框
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // 填充表格数据
                const tbody = document.getElementById('stock-history-body');
                tbody.innerHTML = '';

                if (transactions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                暂无库存变动记录
                            </td>
                        </tr>
                    `;
                } else {
                    transactions.forEach(trans => {
                        const date = new Date(trans.transaction_date).toLocaleString('zh-CN');
                        const changeClass = trans.quantity_change > 0 ? 'text-success' : 'text-danger';
                        const changeSign = trans.quantity_change > 0 ? '+' : '';
                        const typeClass = trans.transaction_type === '采购入库' ? 'badge bg-success' :
                                        trans.transaction_type === '销售出库' ? 'badge bg-danger' :
                                        trans.transaction_type === '库存调整' ? 'badge bg-info' : 'badge bg-secondary';
                        const typeText = trans.transaction_type === '采购入库' ? '采购' :
                                       trans.transaction_type === '销售出库' ? '销售' :
                                       trans.transaction_type === '库存调整' ? '调整' : '其他';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><small>${date}</small></td>
                            <td><span class="${typeClass}">${typeText}</span></td>
                            <td>${trans.quantity_before}</td>
                            <td class="${changeClass} fw-bold">${changeSign}${trans.quantity_change}</td>
                            <td>${trans.quantity_after}</td>
                            <td><small>${trans.notes || '-'}</small></td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // 绘制库存趋势图表
                setTimeout(() => {
                    drawStockHistoryChart(transactions);
                }, 100);

                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('stockHistoryModal'));
                modal.show();

            } catch (error) {
                console.error('查看库存历史失败:', error);
                alert('查看库存历史失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function drawStockHistoryChart(transactions) {
            try {
                const ctx = document.getElementById('stockHistoryChart');
                if (!ctx) return;

                // 准备数据（按时间排序）
                const sortedTrans = [...transactions].sort((a, b) =>
                    new Date(a.transaction_date) - new Date(b.transaction_date)
                );

                const labels = sortedTrans.map(trans =>
                    new Date(trans.transaction_date).toLocaleDateString('zh-CN')
                );

                const stockData = sortedTrans.map(trans => trans.quantity_after);

                // 创建图表
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '库存量',
                            data: stockData,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('绘制库存历史图表失败:', error);
            }
        }

        function purchaseStock(productId) {
            alert('采购补货功能正在开发中...\n\n请使用"采购管理"功能创建采购订单');
            // 这里可以导航到采购管理标签页
            switchTab('purchase');
        }

        // ==================== 采购管理功能 ====================
        async function loadSuppliersForSelect() {
            try {
                const res = await fetch(`${API_BASE}/suppliers`);
                if (res.ok) {
                    const suppliers = await res.json();

                    // 更新采购订单模态框的供应商选择
                    const purchaseSelect = document.getElementById('purchase-supplier-select');
                    const filterSelect = document.getElementById('filter-purchase-supplier');

                    // 清空现有选项
                    [purchaseSelect, filterSelect].forEach(select => {
                        if (select) {
                            select.innerHTML = '<option value="">选择供应商</option>';
                        }
                    });

                    // 添加新选项
                    suppliers.forEach(supplier => {
                        const optionText = `${supplier.supplier_code} - ${supplier.supplier_name}`;

                        if (purchaseSelect) {
                            const option = document.createElement('option');
                            option.value = supplier.supplier_id;
                            option.textContent = optionText;
                            purchaseSelect.appendChild(option);
                        }

                        if (filterSelect) {
                            const option = document.createElement('option');
                            option.value = supplier.supplier_id;
                            option.textContent = optionText;
                            filterSelect.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('加载供应商选择列表失败:', error);
            }
        }

        async function loadPurchaseOrders(page = 1) {
            try {
                showLoading(true);

                const status = document.getElementById('filter-purchase-status').value;
                const supplier = document.getElementById('filter-purchase-supplier').value;
                const date = document.getElementById('filter-purchase-date').value;
                const search = document.getElementById('search-purchase').value;

                let url = `${API_BASE}/purchase/orders?page=${page}&limit=15`;
                if (status) url += `&status=${status}`;
                if (supplier) url += `&supplier_id=${supplier}`;
                if (date) url += `&date=${date}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                purchaseOrdersData = data.data || [];

                // 填充采购订单表格
                const tbody = document.querySelector('#purchase-orders-table tbody');
                tbody.innerHTML = '';

                if (purchaseOrdersData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                                <p>暂无采购订单</p>
                                <button class="btn btn-primary btn-sm" onclick="showNewPurchaseOrderModal()">
                                    <i class="fas fa-plus me-1"></i>创建第一个采购订单
                                </button>
                            </td>
                        </tr>
                    `;
                } else {
                    purchaseOrdersData.forEach(order => {
                        const statusClass = order.status === '已完成' ? 'status-badge status-completed' :
                                          order.status === '已取消' ? 'status-badge status-cancelled' :
                                          order.status === '待审核' ? 'status-badge status-pending' :
                                          'status-badge status-active';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${order.order_number}</strong></td>
                            <td>${order.supplier_name || '-'}</td>
                            <td>${formatDate(order.order_date)}</td>
                            <td>${formatDate(order.expected_delivery_date)}</td>
                            <td>${formatCurrency(order.total_amount)}</td>
                            <td><span class="${statusClass}">${order.status}</span></td>
                            <td>${order.created_by || '-'}</td>
                            <td>
                                <div class="btn-action-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewPurchaseOrder(${order.order_id})" title="查看">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="approvePurchaseOrder(${order.order_id})" title="审核" ${order.status !== '待审核' ? 'disabled' : ''}>
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="cancelPurchaseOrder(${order.order_id})" title="取消" ${order.status === '已完成' || order.status === '已取消' ? 'disabled' : ''}>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // 更新分页
                currentPage = page;
                totalPages = data.total_pages || 1;
                updatePagination('purchase-pagination', page, totalPages, loadPurchaseOrders);

            } catch (error) {
                console.error('加载采购订单失败:', error);
                const tbody = document.querySelector('#purchase-orders-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>加载失败: ${error.message}</p>
                        </td>
                    </tr>
                `;
            } finally {
                showLoading(false);
            }
        }

        function showNewPurchaseOrderModal() {
            // 生成采购订单号
            const orderNumber = `PO-${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
            document.getElementById('purchase-order-number').value = orderNumber;

            // 重置采购项目
            purchaseItems = [];
            updatePurchaseItemsTable();

            const modal = new bootstrap.Modal(document.getElementById('newPurchaseOrderModal'));
            modal.show();
        }

        function addPurchaseItem() {
            // 创建产品选择行
            const row = document.createElement('tr');
            row.className = 'purchase-item-row';
            row.innerHTML = `
                <td>
                    <select class="form-select form-select-sm purchase-product-select" required>
                        <option value="">选择产品</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm purchase-quantity" min="1" value="1" required>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm purchase-price" min="0" step="0.01" placeholder="单价" required>
                </td>
                <td class="purchase-total">¥0.00</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePurchaseItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            // 添加到表格
            const tbody = document.querySelector('#purchase-items-table tbody');
            const noItemsRow = document.getElementById('no-purchase-items');
            if (noItemsRow) {
                noItemsRow.style.display = 'none';
            }

            tbody.appendChild(row);

            // 填充产品选项
            const select = row.querySelector('.purchase-product-select');
            productsData.forEach(product => {
                const option = document.createElement('option');
                option.value = product.product_id;
                option.textContent = `${product.product_code} - ${product.product_name} (¥${product.unit_price})`;
                option.dataset.price = product.unit_price;
                select.appendChild(option);
            });

            // 添加事件监听器
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.price) {
                    const priceInput = row.querySelector('.purchase-price');
                    priceInput.value = selectedOption.dataset.price;
                    updatePurchaseItemTotal(row);
                }
            });

            row.querySelector('.purchase-quantity').addEventListener('input', () => updatePurchaseItemTotal(row));
            row.querySelector('.purchase-price').addEventListener('input', () => updatePurchaseItemTotal(row));

            // 添加到采购项目数组
            purchaseItems.push({
                row: row,
                product_id: null,
                quantity: 1,
                unit_price: 0,
                total: 0
            });

            updatePurchaseOrderTotal();
        }

        function updatePurchaseItemTotal(row) {
            const quantity = parseFloat(row.querySelector('.purchase-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.purchase-price').value) || 0;
            const total = quantity * price;

            row.querySelector('.purchase-total').textContent = formatCurrency(total);

            // 更新采购项目数组
            const index = Array.from(document.querySelectorAll('.purchase-item-row')).indexOf(row);
            if (index >= 0 && purchaseItems[index]) {
                purchaseItems[index].quantity = quantity;
                purchaseItems[index].unit_price = price;
                purchaseItems[index].total = total;

                const select = row.querySelector('.purchase-product-select');
                purchaseItems[index].product_id = select.value;
            }

            updatePurchaseOrderTotal();
        }

        function removePurchaseItem(button) {
            const row = button.closest('tr');
            const index = Array.from(document.querySelectorAll('.purchase-item-row')).indexOf(row);

            if (index >= 0) {
                purchaseItems.splice(index, 1);
                row.remove();
            }

            // 如果没有项目了，显示提示信息
            const tbody = document.querySelector('#purchase-items-table tbody');
            const itemRows = tbody.querySelectorAll('.purchase-item-row');
            if (itemRows.length === 0) {
                const noItemsRow = document.getElementById('no-purchase-items');
                if (noItemsRow) {
                    noItemsRow.style.display = '';
                }
            }

            updatePurchaseOrderTotal();
        }

        function updatePurchaseItemsTable() {
            const tbody = document.querySelector('#purchase-items-table tbody');
            tbody.innerHTML = '';

            if (purchaseItems.length === 0) {
                tbody.innerHTML = `
                    <tr id="no-purchase-items">
                        <td colspan="5" class="text-center text-muted py-4">
                            暂无产品，请点击"添加产品"按钮添加
                        </td>
                    </tr>
                `;
            } else {
                purchaseItems.forEach(item => {
                    tbody.appendChild(item.row);
                });
            }
        }

        function updatePurchaseOrderTotal() {
            let total = 0;
            purchaseItems.forEach(item => {
                total += item.total || 0;
            });

            document.getElementById('purchase-total-amount').textContent = total.toFixed(2);
        }

        async function submitPurchaseOrder() {
            try {
                const supplierId = document.getElementById('purchase-supplier-select').value;
                const orderDate = document.getElementById('purchase-order-date').value;
                const deliveryDate = document.getElementById('purchase-delivery-date').value;
                const notes = document.getElementById('purchase-notes').value;
                const priority = document.getElementById('purchase-priority').value;

                if (!supplierId) {
                    alert('请选择供应商');
                    return;
                }

                if (purchaseItems.length === 0) {
                    alert('请添加至少一个采购项目');
                    return;
                }

                // 验证所有采购项目
                for (let i = 0; i < purchaseItems.length; i++) {
                    const item = purchaseItems[i];
                    if (!item.product_id || !item.quantity || item.quantity <= 0 || !item.unit_price || item.unit_price <= 0) {
                        alert(`请完善第${i + 1}个采购项目的信息（产品、数量、单价）`);
                        return;
                    }
                }

                // 准备订单数据
                const orderData = {
                    supplier_id: parseInt(supplierId),
                    order_date: orderDate,
                    expected_delivery_date: deliveryDate,
                    total_amount: purchaseItems.reduce((sum, item) => sum + item.total, 0),
                    status: '待审核',
                    notes: notes,
                    priority: priority,
                    created_by: '管理员',
                    items: purchaseItems.map(item => ({
                        product_id: parseInt(item.product_id),
                        quantity: parseInt(item.quantity),
                        unit_price: parseFloat(item.unit_price)
                    }))
                };

                console.log('提交采购订单数据:', orderData);

                const confirmMessage = `确认提交采购订单吗？\n\n供应商: ${document.getElementById('purchase-supplier-select').options[document.getElementById('purchase-supplier-select').selectedIndex].text}\n订单总额: ${formatCurrency(orderData.total_amount)}\n采购项目: ${orderData.items.length}个`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                showLoading(true);

                // 发送采购订单请求
                const res = await fetch(`${API_BASE}/purchase/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(`✅ 采购订单提交成功！\n\n订单号: ${result.order_number}\n状态: ${result.status}\n\n请等待审核通过后，库存会自动更新。`);

                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('newPurchaseOrderModal')).hide();

                    // 刷新数据
                    if (currentTab === 'purchase') {
                        loadPurchaseOrders(1);
                    }

                    loadDashboardData();

                } else {
                    const error = await res.json();
                    alert(`❌ 提交失败: ${error.error || '未知错误'}`);
                }

            } catch (error) {
                console.error('提交采购订单失败:', error);
                alert('提交采购订单失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function viewPurchaseOrder(orderId) {
            try {
                showLoading(true);

                // 获取采购订单详情
                const res = await fetch(`${API_BASE}/purchase/orders/${orderId}`);
                if (!res.ok) {
                    throw new Error('获取采购订单信息失败');
                }

                const order = await res.json();

                // 创建详情模态框
                const modalHtml = `
                    <div class="modal fade" id="viewPurchaseOrderModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">采购订单详情 - ${order.order_number}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>基本信息</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <th width="40%">订单号:</th>
                                                    <td>${order.order_number}</td>
                                                </tr>
                                                <tr>
                                                    <th>供应商:</th>
                                                    <td>${order.supplier_name || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <th>订单日期:</th>
                                                    <td>${formatDate(order.order_date)}</td>
                                                </tr>
                                                <tr>
                                                    <th>预计交货:</th>
                                                    <td>${formatDate(order.expected_delivery_date)}</td>
                                                </tr>
                                                <tr>
                                                    <th>实际交货:</th>
                                                    <td>${formatDate(order.actual_delivery_date) || '未交货'}</td>
                                                </tr>
                                                <tr>
                                                    <th>订单总额:</th>
                                                    <td class="fw-bold">${formatCurrency(order.total_amount)}</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>状态信息</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <th width="40%">订单状态:</th>
                                                    <td>
                                                        ${order.status === '已完成' ? '<span class="status-badge status-completed">已完成</span>' :
                                                          order.status === '已取消' ? '<span class="status-badge status-cancelled">已取消</span>' :
                                                          order.status === '待审核' ? '<span class="status-badge status-pending">待审核</span>' :
                                                          order.status === '已批准' ? '<span class="status-badge status-active">已批准</span>' :
                                                          order.status === '已发货' ? '<span class="status-badge status-active">已发货</span>' :
                                                          '<span class="status-badge">未知</span>'}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>创建人:</th>
                                                    <td>${order.created_by || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <th>创建时间:</th>
                                                    <td>${new Date(order.created_at).toLocaleString('zh-CN')}</td>
                                                </tr>
                                                <tr>
                                                    <th>更新时间:</th>
                                                    <td>${new Date(order.updated_at).toLocaleString('zh-CN')}</td>
                                                </tr>
                                                <tr>
                                                    <th>优先级:</th>
                                                    <td>
                                                        ${order.priority === '高' ? '<span class="priority-badge priority-high">高</span>' :
                                                          order.priority === '中' ? '<span class="priority-badge priority-medium">中</span>' :
                                                          '<span class="priority-badge priority-low">低</span>'}
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <h6>备注</h6>
                                            <div class="card">
                                                <div class="card-body">
                                                    ${order.notes || '<span class="text-muted">无备注</span>'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <h6>采购明细</h6>
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>产品编码</th>
                                                            <th>产品名称</th>
                                                            <th>数量</th>
                                                            <th>单价</th>
                                                            <th>金额</th>
                                                            <th>已收货</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="purchase-order-items-body">
                                                        <!-- 动态生成 -->
                                                    </tbody>
                                                    <tfoot>
                                                        <tr class="table-light">
                                                            <td colspan="4" class="text-end fw-bold">合计:</td>
                                                            <td class="fw-bold">${formatCurrency(order.total_amount)}</td>
                                                            <td></td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                ${order.status === '待审核' ? `
                                                <button class="btn btn-success me-md-2" onclick="approvePurchaseOrder(${order.order_id})">
                                                    <i class="fas fa-check me-1"></i>审核通过
                                                </button>
                                                ` : ''}

                                                ${order.status !== '已完成' && order.status !== '已取消' ? `
                                                <button class="btn btn-danger" onclick="cancelPurchaseOrder(${order.order_id})">
                                                    <i class="fas fa-times me-1"></i>取消订单
                                                </button>
                                                ` : ''}

                                                ${order.status === '已批准' ? `
                                                <button class="btn btn-info me-md-2" onclick="receivePurchaseOrder(${order.order_id})">
                                                    <i class="fas fa-truck me-1"></i>确认收货
                                                </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 移除旧的模态框
                const oldModal = document.getElementById('viewPurchaseOrderModal');
                if (oldModal) oldModal.remove();

                // 添加新的模态框
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // 填充采购明细
                const tbody = document.getElementById('purchase-order-items-body');
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.product_code || '-'}</td>
                            <td>${item.product_name || '-'}</td>
                            <td>${item.quantity}</td>
                            <td>${formatCurrency(item.unit_price)}</td>
                            <td>${formatCurrency(item.total_price || item.quantity * item.unit_price)}</td>
                            <td>${item.received_quantity || 0}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                暂无采购明细
                            </td>
                        </tr>
                    `;
                }

                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('viewPurchaseOrderModal'));
                modal.show();

            } catch (error) {
                console.error('查看采购订单失败:', error);
                alert('查看采购订单失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function approvePurchaseOrder(orderId) {
            if (!confirm('确定要审核通过这个采购订单吗？\n\n审核通过后，采购的商品将入库，库存会增加。')) {
                return;
            }

            try {
                showLoading(true);

                const res = await fetch(`${API_BASE}/purchase/orders/${orderId}/approve`, {
                    method: 'PUT'
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(`✅ 采购订单审核通过！\n\n订单号: ${result.order_number}\n状态: ${result.status}\n\n库存已更新。`);

                    // 关闭所有相关的模态框
                    const modals = ['viewPurchaseOrderModal', 'editPurchaseOrderModal'];
                    modals.forEach(modalId => {
                        const modalElement = document.getElementById(modalId);
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) modalInstance.hide();
                        }
                    });

                    // 刷新数据
                    if (currentTab === 'purchase') {
                        loadPurchaseOrders(currentPage);
                    }

                    loadDashboardData();

                } else {
                    const error = await res.json();
                    alert(`❌ 审核失败: ${error.error || '未知错误'}`);
                }

            } catch (error) {
                console.error('审核采购订单失败:', error);
                alert('审核采购订单失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function cancelPurchaseOrder(orderId) {
            if (!confirm('确定要取消这个采购订单吗？\n\n此操作不可撤销。')) {
                return;
            }

            try {
                showLoading(true);

                const res = await fetch(`${API_BASE}/purchase/orders/${orderId}/cancel`, {
                    method: 'PUT'
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(`✅ 采购订单已取消！\n\n订单号: ${result.order_number}\n状态: ${result.status}`);

                    // 关闭所有相关的模态框
                    const modals = ['viewPurchaseOrderModal', 'editPurchaseOrderModal'];
                    modals.forEach(modalId => {
                        const modalElement = document.getElementById(modalId);
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) modalInstance.hide();
                        }
                    });

                    // 刷新数据
                    if (currentTab === 'purchase') {
                        loadPurchaseOrders(currentPage);
                    }

                } else {
                    const error = await res.json();
                    alert(`❌ 取消失败: ${error.error || '未知错误'}`);
                }

            } catch (error) {
                console.error('取消采购订单失败:', error);
                alert('取消采购订单失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // ==================== 销售管理功能 ====================
        async function loadCustomersForSelect() {
            try {
                const res = await fetch(`${API_BASE}/customers`);
                if (res.ok) {
                    const customers = await res.json();

                    // 更新销售订单模态框的客户选择
                    const salesSelect = document.getElementById('sales-customer-select');
                    const filterSelect = document.getElementById('filter-sales-customer');

                    // 清空现有选项
                    [salesSelect, filterSelect].forEach(select => {
                        if (select) {
                            select.innerHTML = '<option value="">选择客户</option>';
                        }
                    });

                    // 添加新选项
                    customers.forEach(customer => {
                        const optionText = `${customer.customer_code} - ${customer.customer_name}`;

                        if (salesSelect) {
                            const option = document.createElement('option');
                            option.value = customer.customer_id;
                            option.textContent = optionText;
                            salesSelect.appendChild(option);
                        }

                        if (filterSelect) {
                            const option = document.createElement('option');
                            option.value = customer.customer_id;
                            option.textContent = optionText;
                            filterSelect.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('加载客户选择列表失败:', error);
            }
        }

        async function loadSalesOrders(page = 1) {
            try {
                showLoading(true);

                const status = document.getElementById('filter-sales-status').value;
                const customer = document.getElementById('filter-sales-customer').value;
                const payment = document.getElementById('filter-sales-payment').value;
                const search = document.getElementById('search-sales').value;

                let url = `${API_BASE}/sales/orders?page=${page}&limit=15`;
                if (status) url += `&status=${status}`;
                if (customer) url += `&customer_id=${customer}`;
                if (payment) url += `&payment_status=${payment}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                salesOrdersData = data.data || [];

                // 填充销售订单表格
                const tbody = document.querySelector('#sales-orders-table tbody');
                tbody.innerHTML = '';

                if (salesOrdersData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-file-invoice-dollar fa-2x mb-3"></i>
                                <p>暂无销售订单</p>
                                <button class="btn btn-primary btn-sm" onclick="showNewSalesOrderModal()">
                                    <i class="fas fa-plus me-1"></i>创建第一个销售订单
                                </button>
                            </td>
                        </tr>
                    `;
                } else {
                    salesOrdersData.forEach(order => {
                        const statusClass = order.status === '已完成' ? 'status-badge status-completed' :
                                          order.status === '已取消' ? 'status-badge status-cancelled' :
                                          order.status === '待处理' ? 'status-badge status-pending' :
                                          'status-badge status-active';

                        const paymentClass = order.payment_status === '已支付' ? 'status-badge status-completed' :
                                           order.payment_status === '部分支付' ? 'status-badge status-pending' :
                                           'status-badge status-inactive';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${order.order_number}</strong></td>
                            <td>${order.customer_name || '-'}</td>
                            <td>${formatDate(order.order_date)}</td>
                            <td>${formatDate(order.delivery_date) || '-'}</td>
                            <td>${formatCurrency(order.total_amount)}</td>
                            <td><span class="${statusClass}">${order.status}</span></td>
                            <td><span class="${paymentClass}">${order.payment_status}</span></td>
                            <td>${order.created_by || '-'}</td>
                            <td>
                                <div class="btn-action-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewSalesOrder(${order.order_id})" title="查看">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="confirmSalesOrder(${order.order_id})" title="确认" ${order.status !== '待处理' ? 'disabled' : ''}>
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="cancelSalesOrder(${order.order_id})" title="取消" ${order.status === '已完成' || order.status === '已取消' ? 'disabled' : ''}>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // 更新分页
                currentPage = page;
                totalPages = data.total_pages || 1;
                updatePagination('sales-pagination', page, totalPages, loadSalesOrders);

            } catch (error) {
                console.error('加载销售订单失败:', error);
                const tbody = document.querySelector('#sales-orders-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>加载失败: ${error.message}</p>
                        </td>
                    </tr>
                `;
            } finally {
                showLoading(false);
            }
        }

        function showNewSalesOrderModal() {
            // 生成销售订单号
            const orderNumber = `SO-${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
            document.getElementById('sales-order-number').value = orderNumber;

            // 重置销售项目
            salesItems = [];
            updateSalesItemsTable();

            const modal = new bootstrap.Modal(document.getElementById('newSalesOrderModal'));
            modal.show();
        }

        function addSalesItem() {
            // 创建产品选择行
            const row = document.createElement('tr');
            row.className = 'sales-item-row';
            row.innerHTML = `
                <td>
                    <select class="form-select form-select-sm sales-product-select" required>
                        <option value="">选择产品</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm sales-quantity" min="1" value="1" required>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm sales-price" min="0" step="0.01" placeholder="单价" required>
                </td>
                <td class="sales-total">¥0.00</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSalesItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            // 添加到表格
            const tbody = document.querySelector('#sales-items-table tbody');
            const noItemsRow = document.getElementById('no-sales-items');
            if (noItemsRow) {
                noItemsRow.style.display = 'none';
            }

            tbody.appendChild(row);

            // 填充产品选项
            const select = row.querySelector('.sales-product-select');
            productsData.forEach(product => {
                const option = document.createElement('option');
                option.value = product.product_id;
                option.textContent = `${product.product_code} - ${product.product_name} (库存: ${product.current_stock}, 单价: ¥${product.unit_price})`;
                option.dataset.price = product.unit_price;
                option.dataset.stock = product.current_stock;
                select.appendChild(option);
            });

            // 添加事件监听器
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.price) {
                    const priceInput = row.querySelector('.sales-price');
                    priceInput.value = selectedOption.dataset.price;

                    // 检查库存
                    const stock = parseInt(selectedOption.dataset.stock) || 0;
                    const quantityInput = row.querySelector('.sales-quantity');
                    if (parseInt(quantityInput.value) > stock) {
                        alert(`⚠️  库存不足！\n\n当前库存: ${stock}\n建议数量: ${stock}`);
                        quantityInput.value = Math.min(parseInt(quantityInput.value), stock);
                    }

                    updateSalesItemTotal(row);
                }
            });

            row.querySelector('.sales-quantity').addEventListener('input', function() {
                const select = row.querySelector('.sales-product-select');
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption && selectedOption.dataset.stock) {
                    const stock = parseInt(selectedOption.dataset.stock) || 0;
                    const quantity = parseInt(this.value) || 0;
                    if (quantity > stock) {
                        alert(`⚠️  库存不足！\n\n当前库存: ${stock}`);
                        this.value = stock;
                    }
                }
                updateSalesItemTotal(row);
            });

            row.querySelector('.sales-price').addEventListener('input', () => updateSalesItemTotal(row));

            // 添加到销售项目数组
            salesItems.push({
                row: row,
                product_id: null,
                quantity: 1,
                unit_price: 0,
                total: 0
            });

            updateSalesOrderTotal();
        }

        function updateSalesItemTotal(row) {
            const quantity = parseFloat(row.querySelector('.sales-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.sales-price').value) || 0;
            const total = quantity * price;

            row.querySelector('.sales-total').textContent = formatCurrency(total);

            // 更新销售项目数组
            const index = Array.from(document.querySelectorAll('.sales-item-row')).indexOf(row);
            if (index >= 0 && salesItems[index]) {
                salesItems[index].quantity = quantity;
                salesItems[index].unit_price = price;
                salesItems[index].total = total;

                const select = row.querySelector('.sales-product-select');
                salesItems[index].product_id = select.value;
            }

            updateSalesOrderTotal();
        }

        function removeSalesItem(button) {
            const row = button.closest('tr');
            const index = Array.from(document.querySelectorAll('.sales-item-row')).indexOf(row);

            if (index >= 0) {
                salesItems.splice(index, 1);
                row.remove();
            }

            // 如果没有项目了，显示提示信息
            const tbody = document.querySelector('#sales-items-table tbody');
            const itemRows = tbody.querySelectorAll('.sales-item-row');
            if (itemRows.length === 0) {
                const noItemsRow = document.getElementById('no-sales-items');
                if (noItemsRow) {
                    noItemsRow.style.display = '';
                }
            }

            updateSalesOrderTotal();
        }

        function updateSalesItemsTable() {
            const tbody = document.querySelector('#sales-items-table tbody');
            tbody.innerHTML = '';

            if (salesItems.length === 0) {
                tbody.innerHTML = `
                    <tr id="no-sales-items">
                        <td colspan="5" class="text-center text-muted py-4">
                            暂无产品，请点击"添加产品"按钮添加
                        </td>
                    </tr>
                `;
            } else {
                salesItems.forEach(item => {
                    tbody.appendChild(item.row);
                });
            }
        }

        function updateSalesOrderTotal() {
            let total = 0;
            salesItems.forEach(item => {
                total += item.total || 0;
            });

            document.getElementById('sales-total-amount').textContent = total.toFixed(2);
        }

        async function submitSalesOrder() {
            try {
                const customerId = document.getElementById('sales-customer-select').value;
                const orderDate = document.getElementById('sales-order-date').value;
                const deliveryDate = document.getElementById('sales-delivery-date').value;
                const paymentMethod = document.getElementById('sales-payment-method').value;
                const notes = document.getElementById('sales-notes').value;

                if (!customerId) {
                    alert('请选择客户');
                    return;
                }

                if (salesItems.length === 0) {
                    alert('请添加至少一个销售项目');
                    return;
                }

                // 验证所有销售项目
                for (let i = 0; i < salesItems.length; i++) {
                    const item = salesItems[i];
                    if (!item.product_id || !item.quantity || item.quantity <= 0 || !item.unit_price || item.unit_price <= 0) {
                        alert(`请完善第${i + 1}个销售项目的信息（产品、数量、单价）`);
                        return;
                    }

                    // 检查库存
                    const product = productsData.find(p => p.product_id == item.product_id);
                    if (product && product.current_stock < item.quantity) {
                        alert(`库存不足！\n\n产品: ${product.product_name}\n所需数量: ${item.quantity}\n当前库存: ${product.current_stock}`);
                        return;
                    }
                }

                // 准备订单数据
                const orderData = {
                    customer_id: parseInt(customerId),
                    order_date: orderDate,
                    delivery_date: deliveryDate || null,
                    total_amount: salesItems.reduce((sum, item) => sum + item.total, 0),
                    status: '待处理',
                    payment_status: '未支付',
                    payment_method: paymentMethod,
                    notes: notes,
                    created_by: '管理员',
                    items: salesItems.map(item => ({
                        product_id: parseInt(item.product_id),
                        quantity: parseInt(item.quantity),
                        unit_price: parseFloat(item.unit_price)
                    }))
                };

                console.log('提交销售订单数据:', orderData);

                const confirmMessage = `确认提交销售订单吗？\n\n客户: ${document.getElementById('sales-customer-select').options[document.getElementById('sales-customer-select').selectedIndex].text}\n订单总额: ${formatCurrency(orderData.total_amount)}\n销售项目: ${orderData.items.length}个\n\n注意：提交后将立即扣减库存！`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                showLoading(true);

                // 发送销售订单请求
                const res = await fetch(`${API_BASE}/sales/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(`✅ 销售订单提交成功！\n\n订单号: ${result.order_number}\n状态: ${result.status}\n\n库存已自动扣减。`);

                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('newSalesOrderModal')).hide();

                    // 刷新数据
                    if (currentTab === 'sales') {
                        loadSalesOrders(1);
                    }

                    loadDashboardData();

                } else {
                    const error = await res.json();
                    alert(`❌ 提交失败: ${error.error || '未知错误'}`);
                }

            } catch (error) {
                console.error('提交销售订单失败:', error);
                alert('提交销售订单失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // ==================== 分页函数 ====================
        function updatePagination(paginationId, currentPage, totalPages, callback) {
            const pagination = document.getElementById(paginationId);
            if (!pagination) return;

            pagination.innerHTML = '';

            // 添加上一页按钮
            const prevItem = document.createElement('li');
            prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevItem.innerHTML = `
                <a class="page-link" href="#" ${currentPage === 1 ? 'tabindex="-1"' : ''} onclick="${currentPage === 1 ? 'return false;' : `loadPage(${currentPage - 1}, ${totalPages}, callback)`}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            `;
            pagination.appendChild(prevItem);

            // 添加页码按钮
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageItem.innerHTML = `
                    <a class="page-link" href="#" onclick="loadPage(${i}, ${totalPages}, callback)">${i}</a>
                `;
                pagination.appendChild(pageItem);
            }

            // 添加下一页按钮
            const nextItem = document.createElement('li');
            nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextItem.innerHTML = `
                <a class="page-link" href="#" ${currentPage === totalPages ? 'tabindex="-1"' : ''} onclick="${currentPage === totalPages ? 'return false;' : `loadPage(${currentPage + 1}, ${totalPages}, callback)`}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            `;
            pagination.appendChild(nextItem);
        }

        function loadPage(page, totalPages, callback) {
            if (page < 1 || page > totalPages) return;

            if (typeof callback === 'function') {
                callback(page);
            }
        }

        // ==================== 系统功能 ====================
        function updateApiUrl() {
            const newUrl = document.getElementById('api-url').value.trim();
            if (!newUrl) {
                alert('请输入有效的API地址');
                return;
            }

            if (!newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
                alert('API地址必须以http://或https://开头');
                return;
            }

            API_BASE = newUrl;
            document.getElementById('current-api-url').textContent = API_BASE;
            document.getElementById('system-info-api-url').textContent = API_BASE;

            alert('API地址已更新为: ' + API_BASE);

            // 测试新连接
            testConnection();
        }

        function showSystemInfo() {
            const modal = new bootstrap.Modal(document.getElementById('systemInfoModal'));

            // 更新系统信息
            const now = new Date();
            document.getElementById('last-sync').textContent = now.toLocaleString('zh-CN');

            // 检查API端点状态
            checkApiEndpoints();

            modal.show();
        }

        async function checkApiEndpoints() {
            const endpoints = document.getElementById('system-info-endpoints');
            if (!endpoints) return;

            const endpointList = [
                { name: '产品管理', url: '/api/products', method: 'GET' },
                { name: '库存管理', url: '/api/inventory/alerts', method: 'GET' },
                { name: '采购管理', url: '/api/purchase/orders', method: 'GET' },
                { name: '销售管理', url: '/api/sales/orders', method: 'GET' },
                { name: '客户管理', url: '/api/customers', method: 'GET' },
                { name: '供应商管理', url: '/api/suppliers', method: 'GET' }
            ];

            endpoints.innerHTML = '';

            for (const endpoint of endpointList) {
                const li = document.createElement('li');

                try {
                    const res = await fetch(API_BASE.replace('/api', '') + endpoint.url);
                    if (res.ok) {
                        li.innerHTML = `<i class="fas fa-check text-success me-2"></i>${endpoint.name}: <code>${endpoint.url}</code>`;
                    } else {
                        li.innerHTML = `<i class="fas fa-times text-danger me-2"></i>${endpoint.name}: <code>${endpoint.url}</code>`;
                    }
                } catch (error) {
                    li.innerHTML = `<i class="fas fa-times text-danger me-2"></i>${endpoint.name}: <code>${endpoint.url}</code>`;
                }

                endpoints.appendChild(li);
            }
        }

        function showDatabaseStatus() {
            testConnection().then(connected => {
                if (connected) {
                    alert('✅ 数据库连接正常\n\n所有数据库操作都可以正常执行。');
                } else {
                    alert('❌ 数据库连接失败\n\n请检查数据库服务是否正在运行。');
                }
            });
        }

        function clearCache() {
            if (confirm('确定要清除所有缓存数据吗？\n\n这不会删除数据库中的数据，只会清除前端的缓存。')) {
                // 清除本地存储
                localStorage.clear();
                sessionStorage.clear();

                // 重新加载数据
                alert('缓存已清除，正在重新加载数据...');
                location.reload();
            }
        }

        function backupDatabase() {
            alert('数据库备份功能正在开发中...\n\n目前请使用MySQL的备份工具进行数据库备份。');
        }

        function loadAllData() {
            alert('正在重新加载所有数据...');

            // 刷新当前标签页数据
            loadTabData(currentTab);

            // 刷新仪表盘数据
            loadDashboardData();
        }

        function loadSystemInfo() {
            // 更新系统信息
            const now = new Date();
            document.getElementById('last-sync').textContent = now.toLocaleString('zh-CN');

            // 检查数据库状态
            testConnection().then(connected => {
                if (connected) {
                    document.getElementById('database-status').innerHTML = `
                        <div class="text-success">
                            <i class="fas fa-check-circle me-2"></i>
                            数据库连接正常
                        </div>
                        <small class="text-muted">最后检查: ${now.toLocaleString('zh-CN')}</small>
                    `;
                } else {
                    document.getElementById('database-status').innerHTML = `
                        <div class="text-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            数据库连接失败
                        </div>
                        <small class="text-muted">请检查数据库服务</small>
                    `;
                }
            });
        }

        // ==================== 其他辅助函数 ====================
        function exportCustomers() {
            alert('客户导出功能正在开发中...');
        }

        function exportSuppliers() {
            alert('供应商导出功能正在开发中...');
        }

        function loadReports() {
            // 初始化报告图表
            if (document.getElementById('reportChart')) {
                createPlaceholderChart('reportChart', 'bar', ['暂无数据'], [0]);
            }

            if (document.getElementById('purchaseChart')) {
                createPlaceholderChart('purchaseChart', 'pie', ['暂无数据'], [1]);
            }

            if (document.getElementById('inventoryChart')) {
                createPlaceholderChart('inventoryChart', 'line', ['暂无数据'], [0]);
            }
        }

        function generateReport() {
            alert('生成报表功能正在开发中...\n\n暂时请使用仪表盘中的统计图表。');
        }

        // 初始化完成
        console.log('工厂氟胶垫片库存管理系统前端初始化完成！');

        // 显示欢迎消息
        setTimeout(() => {
            console.log('欢迎使用工厂氟胶垫片库存管理系统！');
            console.log('系统已准备就绪，请开始使用。');
        }, 1000);
    </script>
</body>
</html>